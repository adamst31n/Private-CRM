<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Personal Relationship CRM - Stay connected with people who matter">
  <title>Relationship CRM</title>

  <style>
    /* ===== CSS RESET & BASE STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: var(--color-text-primary);
      background-color: var(--color-background);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== CSS VARIABLES ===== */
    :root {
      /* Colors - Status */
      --color-recent: #059669;
      --color-caution: #F59E0B;
      --color-warning: #EA580C;
      --color-overdue: #DC2626;
      --color-never: #6B7280;

      /* Colors - UI */
      --color-primary: #2563EB;
      --color-primary-light: #3B82F6;
      --color-primary-dark: #1D4ED8;
      --color-secondary: #7C3AED;
      --color-accent: #0891B2;
      --color-background: #F9FAFB;
      --color-surface: #FFFFFF;
      --color-surface-elevated: #FFFFFF;
      --color-text-primary: #111827;
      --color-text-secondary: #6B7280;
      --color-border: #E5E7EB;
      --color-border-light: #F3F4F6;
      --color-danger: #DC2626;
      --color-success: #059669;

      /* Spacing */
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;

      /* Sizes */
      --tap-target-min: 48px;
      --border-radius: 0.75rem;
      --border-radius-lg: 1rem;
      --nav-height: 64px;

      /* Shadows */
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* ===== DARK MODE ===== */
    body.dark-mode {
      --color-background: #1a1f2e;
      --color-surface: #2d3748;
      --color-surface-elevated: #3d4b5f;
      --color-text-primary: #F9FAFB;
      --color-text-secondary: #9CA3AF;
      --color-border: #6B7280;
      --color-border-light: #4B5563;
      /* Brighter blues for better contrast */
      --color-primary: #60A5FA;
      --color-primary-light: #93C5FD;
      --color-primary-dark: #3B82F6;
      /* Brighter danger for ASAP visibility */
      --color-danger: #F87171;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode {
      background-color: var(--color-background);
    }

    /* Dark mode specific overrides for better contrast */
    body.dark-mode .card {
      border-color: var(--color-border);
    }

    body.dark-mode [style*="border-left: 3px solid var(--color-danger)"],
    body.dark-mode [style*="border-left: 3px solid var(--color-primary)"] {
      border-left-width: 4px !important;
    }

    /* Dark mode header enhancements */
    body.dark-mode .app-header {
      background: linear-gradient(to bottom, var(--color-surface) 0%, var(--color-background) 100%);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .header-title {
      color: #F9FAFB;
    }

    body.dark-mode .header-title:hover {
      color: var(--color-primary-light);
    }

    body.dark-mode .header-btn:hover {
      background: var(--color-surface-elevated);
    }

    body.dark-mode .header-btn-add {
      box-shadow: 0 2px 8px rgba(96, 165, 250, 0.35);
    }

    body.dark-mode .header-btn-add:hover {
      box-shadow: 0 6px 16px rgba(96, 165, 250, 0.45);
    }

    /* Dark mode page header */
    body.dark-mode .page-header {
      background: var(--color-surface-elevated);
      background-image: linear-gradient(var(--color-surface-elevated), var(--color-surface-elevated)),
                        linear-gradient(to right, var(--color-primary), var(--color-primary-light));
      background-origin: padding-box, border-box;
      background-clip: padding-box, border-box;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
    }

    body.dark-mode .view-title {
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Dark mode cards */
    body.dark-mode .card {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(107, 114, 128, 0.3);
    }

    body.dark-mode .card:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
    }
    
    body.dark-mode .card-clickable:hover, 
    body.dark-mode .card-clickable:active {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
      background: var(--color-surface-elevated);
      border-color: var(--color-primary);
    }

    /* Enhanced visual hierarchy for dashboard cards */

    /* Priority/ASAP section - Most urgent, needs maximum prominence */
    body.dark-mode .card-priority {
      border: 2px solid rgba(239, 68, 68, 0.5);
      box-shadow: 0 6px 24px rgba(239, 68, 68, 0.25),
                  0 2px 8px rgba(0, 0, 0, 0.3);
      background: linear-gradient(135deg, 
        rgba(239, 68, 68, 0.08) 0%, 
        var(--color-surface) 50%);
    }

    body.dark-mode .card-priority:hover {
      box-shadow: 0 12px 40px rgba(239, 68, 68, 0.35),
                  0 4px 12px rgba(0, 0, 0, 0.4);
      transform: translateY(-3px);
    }

    /* Needs Attention section - Important but secondary to ASAP */
    body.dark-mode .card-attention {
      border: 1.5px solid rgba(234, 88, 12, 0.4);
      box-shadow: 0 4px 20px rgba(234, 88, 12, 0.2),
                  0 2px 6px rgba(0, 0, 0, 0.25);
      background: linear-gradient(135deg, 
        rgba(234, 88, 12, 0.05) 0%, 
        var(--color-surface) 60%);
    }

    body.dark-mode .card-attention:hover {
      box-shadow: 0 8px 28px rgba(234, 88, 12, 0.3),
                  0 3px 10px rgba(0, 0, 0, 0.35);
      transform: translateY(-2px);
    }

    /* Activity section - Informational, should recede slightly */
    body.dark-mode .card-activity {
      border: 1px solid rgba(107, 114, 128, 0.25);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
      background: var(--color-surface);
    }

    body.dark-mode .card-activity:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
      transform: translateY(-1px);
    }

    /* Birthdays and Stats - Standard informational cards */
    body.dark-mode .card-birthdays,
    body.dark-mode .card-stats {
      border: 1px solid rgba(107, 114, 128, 0.25);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .card-birthdays:hover,
    body.dark-mode .card-stats:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
      transform: translateY(-1px);
    }

    /* Section titles within priority cards get color treatment */
    body.dark-mode .card-priority .section-title {
      color: #FCA5A5;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode .card-attention .section-title {
      color: #FED7AA;
      font-weight: 600;
    }

    /* Dark mode slide menu */
    body.dark-mode .slide-menu {
      box-shadow: 4px 0 32px rgba(0, 0, 0, 0.5);
    }
    
    /* Dark mode button improvements */
    body.dark-mode .btn {
      background: var(--color-surface-elevated);
      border: 1px solid var(--color-border-light);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    body.dark-mode .btn:hover {
      background: var(--color-surface-elevated);
      border-color: var(--color-primary);
      box-shadow: 0 2px 6px rgba(96, 165, 250, 0.25);
      transform: translateY(-1px);
    }
    
    body.dark-mode .btn-primary {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
      box-shadow: 0 2px 8px rgba(96, 165, 250, 0.35);
    }
    
    body.dark-mode .btn-primary:hover {
      background: var(--color-primary-light);
      border-color: var(--color-primary-light);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.45);
    }
    
    body.dark-mode .btn-danger {
      background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);
      border: 2px solid #DC2626;
      color: white;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    body.dark-mode .btn-danger:hover {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      border-color: #EF4444;
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
      transform: translateY(-2px);
    }
    
    /* Dark mode settings section improvements */
    body.dark-mode .settings-section {
      background: var(--color-surface);
      border: 1px solid var(--color-border-light);
    }
    
    /* Dark mode Needs Attention improvements */
    body.dark-mode .card-attention {
      background: var(--color-surface);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
    }
    
    body.dark-mode .needs-attention-grid > div {
      padding: 1rem;
      background: var(--color-background);
      border-radius: 0.5rem;
    }
    
    body.dark-mode .needs-attention-grid h3 {
      color: var(--color-primary-light);
      border-bottom-color: var(--color-primary) !important;
    }
    
    /* Dark mode Priority/Contact ASAP section enhancements */
    body.dark-mode .card[style*="border-left: 4px solid #EF4444"],
    body.dark-mode .card[style*="border-left: 3px solid var(--color-danger)"] {
      border-left-width: 4px !important;
      border-left-color: #EF4444 !important;
      background: linear-gradient(to right, rgba(239, 68, 68, 0.12), var(--color-surface));
      box-shadow: 0 4px 16px rgba(239, 68, 68, 0.2);
    }

    /* Theme toggle button (in header) */
    .theme-toggle {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--color-text-secondary);
      font-size: 1.125rem;
      cursor: pointer;
      border-radius: var(--border-radius);
      transition: background-color 0.2s, color 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .theme-toggle:hover {
      background: var(--color-background);
      color: var(--color-text-primary);
    }

    /* ===== LAYOUT ===== */
    #app {
      padding-top: var(--nav-height);
      min-height: 100vh;
      background: var(--color-background);
    }

    .content-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    @media (min-width: 768px) {
      .content-container {
        padding: 0 2rem;
      }
    }

    .view {
      animation: fadeIn 0.2s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Dashboard grid for desktop */
    .dashboard-grid {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .dashboard-row {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .dashboard-row > * {
      flex: 1;
    }

    /* New dashboard layout with Activity spanning */
    .dashboard-main {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .dashboard-left {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .dashboard-left-row {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .dashboard-activity {
      flex: none;
    }

    /* New dashboard grid - mobile (single column) */
    .dashboard-new-grid {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    /* ===== COMPONENTS ===== */

    /* Buttons */
    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      min-height: var(--tap-target-min);
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }

    .btn:hover, .btn:active {
      background: linear-gradient(135deg, var(--color-primary-dark) 0%, #1E40AF 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary {
      background: var(--color-surface);
      color: var(--color-text-primary);
      border: 1.5px solid var(--color-border);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .btn-secondary:hover {
      background: var(--color-background);
      border-color: var(--color-primary);
      color: var(--color-primary);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-danger {
      background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #B91C1C 0%, #991B1B 100%);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    }

    .btn-block {
      width: 100%;
      display: block;
    }

    /* Cards */
    .card {
      background: var(--color-surface);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--color-border);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .card-clickable {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-clickable:hover, .card-clickable:active {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
      border-color: var(--color-primary);
      background: linear-gradient(to bottom, #FFFFFF, #FAFBFC);
    }

    /* Status indicators */
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: var(--spacing-xs);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 0 2px 4px rgba(0, 0, 0, 0.15);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
    }

    .status-recent {
      background: var(--color-recent);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 0 2px 4px rgba(5, 150, 105, 0.3), 0 0 8px rgba(5, 150, 105, 0.2);
    }
    .status-caution {
      background: var(--color-caution);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 0 2px 4px rgba(245, 158, 11, 0.3), 0 0 8px rgba(245, 158, 11, 0.2);
    }
    .status-warning {
      background: var(--color-warning);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 0 2px 4px rgba(234, 88, 12, 0.3), 0 0 8px rgba(234, 88, 12, 0.2);
    }
    .status-overdue {
      background: var(--color-overdue);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 0 2px 4px rgba(220, 38, 38, 0.3), 0 0 8px rgba(220, 38, 38, 0.2);
    }
    .status-never {
      background: var(--color-never);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 0 2px 4px rgba(107, 114, 128, 0.3);
    }

    /* Forms */
    .form-group {
      margin-bottom: var(--spacing-md);
    }

    .form-label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: 500;
      color: var(--color-text-primary);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      min-height: var(--tap-target-min);
      padding: 0.75rem 1rem;
      border: 1.5px solid rgba(0, 0, 0, 0.12);
      border-radius: var(--border-radius);
      font-size: 0.9375rem;
      font-family: inherit;
      background: var(--color-surface);
      color: var(--color-text-primary);
      transition: all 0.25s ease;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .form-input:hover, .form-select:hover, .form-textarea:hover {
      border-color: rgba(0, 0, 0, 0.2);
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1.25rem;
      padding-right: 2.5rem;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.5;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Icon styles */
    .icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 0.625rem;
      font-size: 0.875rem;
      font-weight: 700;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .icon-phone { background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); color: #1E40AF; }
    .icon-email { background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); color: #92400E; }
    .icon-linkedin { background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%); color: #3730A3; }
    .icon-birthday { background: linear-gradient(135deg, #FCE7F3 0%, #FBCFE8 100%); color: #9F1239; }
    .icon-notes { background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%); color: #6B21A8; }
    .icon-call { background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); color: #1E40AF; }
    .icon-text { background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); color: #065F46; }
    .icon-inperson { background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); color: #92400E; }
    .icon-video { background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%); color: #3730A3; }
    .icon-social { background: linear-gradient(135deg, #FCE7F3 0%, #FBCFE8 100%); color: #9F1239; }

    /* Page Header Section */
    .page-header {
      background: var(--color-surface);
      padding: 1rem 0;
      border-bottom: 2px solid transparent;
      background-image: linear-gradient(var(--color-surface), var(--color-surface)),
                        linear-gradient(to right, var(--color-primary), var(--color-primary-light));
      background-origin: padding-box, border-box;
      background-clip: padding-box, border-box;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
      .page-header {
        padding: 1.25rem 0;
      }
    }

    .view-header {
      margin-bottom: 0;
    }

    .view-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--color-text-primary);
      letter-spacing: -0.02em;
      margin: 0;
      line-height: 1.2;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    @media (min-width: 768px) {
      .view-title {
        font-size: 2rem;
      }
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Contact grid for desktop */
    .contact-grid {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .contact-card-compact {
      padding: 0.75rem !important;
    }

    .contact-card-compact .contact-name {
      font-size: 1rem;
      font-weight: 600;
    }

    .contact-card-compact .contact-meta {
      font-size: 0.75rem;
    }

    /* Activity item hover tooltip */
    .activity-item {
      position: relative;
    }

    .activity-item .activity-tooltip {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 0.5rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 0.75rem;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      font-size: 0.875rem;
      width: 90%;
      max-width: 320px;
      min-width: 240px;
    }

    .activity-item:hover .activity-tooltip {
      display: block;
    }

    /* Tooltip appears above when item is in lower portion of viewport */
    .activity-item.tooltip-above .activity-tooltip {
      top: auto;
      bottom: 100%;
      margin-top: 0;
      margin-bottom: 0.5rem;
    }
    
    /* Contact card upcoming interaction tooltip */
    .upcoming-indicator {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    
    .upcoming-tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 0.5rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 0.5rem 0.75rem;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      font-size: 0.75rem;
      white-space: normal;
      max-width: 280px;
      min-width: 200px;
      line-height: 1.4;
      color: var(--color-text-primary);
      font-weight: 400;
      text-align: left;
      pointer-events: none;
    }
    
    .upcoming-indicator:hover .upcoming-tooltip {
      display: block;
    }

    /* Activity scroll container */
    .activity-scroll {
      overflow-y: auto;
    }

    /* Enhanced activity item contrast for dark mode */
    body.dark-mode .activity-item {
      background: var(--color-surface-elevated) !important;
      border: 1px solid rgba(107, 114, 128, 0.3) !important;
    }

    body.dark-mode .activity-item:hover {
      background: var(--color-surface-elevated) !important;
      border-color: var(--color-primary) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* Enhanced Activity card section headers in dark mode */
    body.dark-mode .card-activity h3 {
      font-weight: 700 !important;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 0.75rem !important;
    }

    /* Contact profile layout */
    .contact-profile-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .contact-info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      color: var(--color-text-primary);
      text-decoration: none;
      cursor: pointer;
      font-size: 0.875rem;
    }

    /* Fixed Header */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--nav-height);
      background: linear-gradient(to bottom, var(--color-surface) 0%, var(--color-background) 100%);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      padding: 0 1.25rem;
      gap: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin: 0;
      white-space: nowrap;
      cursor: pointer;
      letter-spacing: 0.01em;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-title:hover {
      color: var(--color-primary);
      transform: scale(1.02);
    }

    .brand-icon {
      font-size: 1.125rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .header-spacer {
      flex: 1;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--color-text-secondary);
      font-size: 1.375rem;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-tap-highlight-color: transparent;
    }

    .header-btn:hover {
      background: var(--color-surface);
      color: var(--color-text-primary);
      transform: rotate(5deg);
    }

    .header-btn:active {
      background: var(--color-border);
      transform: scale(0.95) rotate(0deg);
    }

    .header-btn-add {
      background: var(--color-primary);
      color: white;
      font-size: 1.5rem;
      font-weight: 500;
      border-radius: 0.75rem;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
      transition: all 0.2s ease;
    }

    .header-btn-add:hover {
      background: var(--color-primary-dark);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }

    .header-btn-add:active {
      background: var(--color-primary-dark);
      transform: scale(0.98);
    }

    /* User Menu */
    .user-menu-container {
      position: relative;
    }

    .user-menu-trigger {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.5rem 0.25rem 0.25rem;
      background: transparent;
      border: 1px solid var(--color-border);
      border-radius: 2rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .user-menu-trigger:hover {
      background: var(--color-surface);
      border-color: var(--color-text-secondary);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--color-primary);
    }

    .user-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-primary);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-menu-arrow {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      transition: transform 0.2s ease;
    }

    .user-menu-container.open .user-menu-arrow {
      transform: rotate(180deg);
    }

    .user-menu-dropdown {
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      min-width: 240px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-lg);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
      z-index: 200;
      overflow: hidden;
    }

    .user-menu-container.open .user-menu-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .user-menu-header {
      padding: 1rem;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .user-menu-header .user-avatar {
      width: 40px;
      height: 40px;
    }

    .user-menu-info {
      flex: 1;
      min-width: 0;
    }

    .user-menu-name {
      font-weight: 600;
      color: var(--color-text-primary);
      font-size: 0.9375rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-menu-email {
      font-size: 0.8125rem;
      color: var(--color-text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-menu-items {
      padding: 0.5rem 0;
    }

    .user-menu-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      color: var(--color-text-primary);
      font-size: 0.9375rem;
      cursor: pointer;
      transition: background 0.15s ease;
      text-align: left;
    }

    .user-menu-item:hover {
      background: var(--color-background);
    }

    .user-menu-item-icon {
      font-size: 1.125rem;
      width: 24px;
      text-align: center;
    }

    .user-menu-divider {
      height: 1px;
      background: var(--color-border);
      margin: 0.5rem 0;
    }

    .user-menu-item-danger {
      color: var(--color-danger);
    }

    .user-menu-item-danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Sign In Button (when logged out) */
    .header-signin-btn {
      padding: 0.5rem 1rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .header-signin-btn:hover {
      background: var(--color-primary-dark);
    }

    /* Floating Action Button (FAB) */
    .fab {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 56px;
      height: 56px;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 2.25rem;
      font-weight: 300;
      line-height: 1;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.45),
                  0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    .fab:hover {
      background: var(--color-primary-light);
      transform: scale(1.1);
      box-shadow: 0 12px 32px rgba(37, 99, 235, 0.55),
                  0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .fab:active {
      transform: scale(0.95);
    }

    body.dark-mode .fab {
      background: var(--color-primary);
      box-shadow: 0 6px 20px rgba(96, 165, 250, 0.5),
                  0 2px 8px rgba(0, 0, 0, 0.4);
    }

    body.dark-mode .fab:hover {
      background: var(--color-primary-light);
      box-shadow: 0 12px 32px rgba(96, 165, 250, 0.6),
                  0 4px 12px rgba(0, 0, 0, 0.5);
    }

    @media (max-width: 768px) {
      .fab {
        bottom: 1.5rem;
        right: 1.5rem;
        width: 52px;
        height: 52px;
      }
      
      /* Stack Needs Attention columns on mobile */
      .needs-attention-grid {
        display: flex !important;
        flex-direction: column !important;
        gap: 1rem !important;
      }
      
      /* Contact detail header - stack on mobile */
      .contact-detail-header {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 1rem !important;
      }
      
      .contact-name-center {
        position: static !important;
        transform: none !important;
        text-align: left !important;
        pointer-events: auto !important;
      }
      
      .contact-name-center h1 {
        white-space: normal !important;
        font-size: 1.25rem !important;
      }
      
      .contact-actions {
        flex-wrap: wrap !important;
        justify-content: flex-start !important;
      }
      
      .contact-actions .btn {
        flex: 1 1 auto !important;
        min-width: fit-content !important;
      }
      
      /* Add padding to forms on mobile to prevent field cutoff */
      .view form {
        padding-bottom: 6rem !important;
      }
    }

    /* Needs Attention Grid - desktop */
    .needs-attention-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    /* Contact Detail Header */
    .contact-detail-header {
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      min-height: 48px;
    }
    
    .contact-name-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      pointer-events: none;
    }
    
    .contact-name-center h1 {
      white-space: nowrap;
    }
    
    .contact-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Hide on mobile */
    @media (max-width: 480px) {
      .user-name {
        display: none;
      }

      .user-menu-trigger {
        padding: 0.25rem;
      }
    }

    /* Hamburger Menu Overlay */
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 150;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Slide-out Menu */
    .slide-menu {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      background: var(--color-surface);
      z-index: 200;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
    }

    .slide-menu.active {
      transform: translateX(0);
    }

    .menu-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .menu-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text-primary);
      margin: 0;
    }

    .menu-close-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--color-text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      border-radius: var(--border-radius);
      transition: background-color 0.2s, color 0.2s;
    }

    .menu-close-btn:hover {
      background: var(--color-background);
      color: var(--color-text-primary);
    }

    .menu-nav {
      flex: 1;
      padding: var(--spacing-sm) 0;
      overflow-y: auto;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: 0.75rem 1.5rem;
      color: var(--color-text-secondary);
      font-size: 1rem;
      font-weight: 400;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      border: none;
      border-left: 3px solid transparent;
      background: transparent;
      width: 100%;
      text-align: left;
      min-height: 48px;
    }

    .menu-item:hover {
      background: var(--color-background);
      color: var(--color-text-primary);
    }

    .menu-item.active {
      background: rgba(37, 99, 235, 0.06);
      color: var(--color-primary);
      font-weight: 500;
      border-left-color: var(--color-primary);
    }

    .menu-item-icon {
      font-size: 1.125rem;
      width: 24px;
      text-align: center;
    }

    /* Mobile responsive menu */
    @media (max-width: 639px) {
      .slide-menu {
        width: 85%;
        max-width: 320px;
      }

      .header-title {
        font-size: 1.125rem;
      }

      .page-header {
        padding: 1rem 0;
        margin-bottom: 1.5rem;
      }
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-md);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--color-surface);
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Toast notifications */
    #toast-container {
      position: fixed;
      top: var(--spacing-md);
      right: var(--spacing-md);
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .toast {
      background: var(--color-text-primary);
      color: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      min-width: 250px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast-success {
      background: var(--color-recent);
    }

    .toast-error {
      background: var(--color-danger);
    }

    /* Interaction type buttons */
    .interaction-types {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: var(--spacing-md);
    }

    .interaction-type-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      min-height: 80px;
      border: 2px solid var(--color-border);
      border-radius: var(--border-radius);
      background: var(--color-surface);
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .interaction-type-btn:hover {
      border-color: var(--color-primary);
      background: rgba(59, 130, 246, 0.05);
    }

    .interaction-type-btn.selected {
      border-color: var(--color-primary);
      background: rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .interaction-type-btn .icon {
      font-size: 2rem;
    }

    .interaction-type-btn .label {
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* Quick date buttons */
    .quick-dates {
      display: flex;
      gap: 0.5rem;
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }

    .quick-date-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      background: var(--color-surface);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .quick-date-btn:hover, .quick-date-btn.selected {
      border-color: var(--color-primary);
      background: rgba(59, 130, 246, 0.1);
      color: var(--color-primary);
    }

    /* Filter chips for multi-select */
    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 0.875rem;
      border: 1.5px solid var(--color-border);
      border-radius: 2rem;
      background: var(--color-surface);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .filter-chip:hover {
      border-color: var(--color-primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .filter-chip.selected {
      border-color: var(--color-primary);
      background: var(--color-primary);
      color: white;
    }

    /* Dark mode filter chip improvements */
    body.dark-mode .filter-chip {
      background: var(--color-surface-elevated);
      border-color: var(--color-border);
      color: var(--color-text-primary);
    }

    body.dark-mode .filter-chip:hover {
      background: var(--color-surface-elevated);
      border-color: var(--color-primary-light);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
    }

    body.dark-mode .filter-chip.selected {
      background: var(--color-primary);
      border-color: var(--color-primary-light);
      color: white;
      box-shadow: 0 2px 8px rgba(96, 165, 250, 0.35);
    }

    /* Utilities */
    .text-center { text-align: center; }
    .text-muted { color: var(--color-text-secondary); }
    .text-small { font-size: 0.875rem; }
    .mb-0 { margin-bottom: 0; }
    .mb-sm { margin-bottom: var(--spacing-sm); }
    .mb-md { margin-bottom: var(--spacing-md); }
    .mb-lg { margin-bottom: var(--spacing-lg); }
    .mt-md { margin-top: var(--spacing-md); }
    .empty-state {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--color-text-secondary);
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: var(--spacing-md);
    }

    /* ===== RESPONSIVE ===== */

    /* Responsive text - show short version on narrow screens */
    .show-on-narrow { display: none; }
    .hide-on-narrow { display: inline; }

    @media (max-width: 500px) {
      .show-on-narrow { display: inline; }
      .hide-on-narrow { display: none; }
    }

    /* Priority Contact ASAP responsive states */
    /* Default (mobile/stacked - below 768px): show full text */
    .status-full { display: inline; }
    .status-short { display: none; }
    .priority-contact-type { display: block; }

    /* Smooth transitions for priority cards */
    .priority-contact-card {
      transition: padding 0.15s ease;
    }
    .priority-contact-type {
      transition: opacity 0.15s ease, max-height 0.15s ease;
      overflow: hidden;
    }

    /* Interim width (768px-1050px: grid is active but tight) */
    @media (min-width: 768px) and (max-width: 1050px) {
      .status-full { display: none; }
      .status-short { display: inline; }
      .priority-contact-type {
        display: none;
      }
    }

    /* Wide desktop (above 1050px): show full version */
    @media (min-width: 1051px) {
      .status-full { display: inline; }
      .status-short { display: none; }
      .priority-contact-type { display: block; }
    }

    @media (min-width: 768px) {
      /* Dashboard responsive grid */
      .dashboard-grid {
        gap: var(--spacing-lg);
      }

      .dashboard-row {
        flex-direction: row;
        gap: var(--spacing-lg);
      }

      .dashboard-row-3 > *:first-child {
        flex: 1;
      }

      .dashboard-row-3 > *:nth-child(2) {
        flex: 1;
      }

      .dashboard-row-3 > *:last-child {
        flex: 1.5;
      }

      /* New dashboard grid with Activity spanning */
      .dashboard-new-grid {
        display: grid;
        grid-template-columns: 0.85fr 1.15fr minmax(280px, 1fr);
        grid-template-rows: auto auto;
        gap: var(--spacing-lg);
      }

      .dashboard-new-grid > .card {
        margin-bottom: 0;
      }

      .dashboard-new-grid .card-priority {
        grid-column: 1;
        grid-row: 1;
      }

      .dashboard-new-grid .card-attention {
        grid-column: 2;
        grid-row: 1;
      }

      .dashboard-new-grid .card-activity {
        grid-column: 3;
        grid-row: 1 / 3;
        max-height: 600px;
        display: flex;
        flex-direction: column;
      }

      .dashboard-new-grid .card-birthdays {
        grid-column: 1;
        grid-row: 2;
      }

      .dashboard-new-grid .card-stats {
        grid-column: 2;
        grid-row: 2;
      }

      .dashboard-new-grid .card-activity .section-title {
        flex: 0 0 auto;
      }

      .dashboard-new-grid .card-activity .activity-scroll {
        flex: 1 1 auto;
        overflow-y: auto;
        min-height: 0;
      }

      /* Cards can be wider on desktop */
      .card {
        padding: var(--spacing-xl);
      }

      /* Contact grid - multiple columns on desktop */
      .contact-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }

      /* Contact profile info - 2 columns on desktop */
      .contact-info-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem 2rem;
      }
    }

    @media (min-width: 1024px) {
      /* Contact profile info - 3 columns on larger desktop */
      .contact-info-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem 2.5rem;
      }
    }

    @media (min-width: 1100px) {
      .contact-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 1200px) {
      .view {
        padding: var(--spacing-xl);
      }
    }
  </style>
</head>
<body>
  <!-- Fixed Header -->
  <header class="app-header">
    <div class="header-left">
      <button class="header-btn" onclick="toggleMenu()" aria-label="Open menu">
        ‚ò∞
      </button>
    </div>
    <span class="header-title" id="header-title"><span class="brand-icon">üë•</span> Personal CRM</span>
    <div class="header-spacer"></div>
    <div class="header-actions">
      <!-- Sign In Button (shown when logged out, hidden on login screen) -->
      <button id="auth-button" class="header-signin-btn" onclick="handleGoogleSignIn()" style="display: none;">
        Sign In
      </button>

      <!-- User Menu (shown when logged in) -->
      <div id="user-menu" class="user-menu-container" style="display: none;">
        <button class="user-menu-trigger" onclick="toggleUserMenu()">
          <img id="user-avatar" class="user-avatar" src="" alt="Profile" />
          <span id="user-name-display" class="user-name"></span>
          <span class="user-menu-arrow">‚ñº</span>
        </button>
        <div class="user-menu-dropdown">
          <div class="user-menu-header">
            <img id="user-avatar-large" class="user-avatar" src="" alt="Profile" />
            <div class="user-menu-info">
              <div id="user-menu-name" class="user-menu-name"></div>
              <div id="user-menu-email" class="user-menu-email"></div>
            </div>
          </div>
          <div class="user-menu-items">
            <button class="user-menu-item" onclick="handleUserMenuAction('add-contact')">
              <span class="user-menu-item-icon">‚ûï</span>
              <span>Add Contact</span>
            </button>
            <button class="user-menu-item" onclick="handleUserMenuAction('toggle-theme')">
              <span class="user-menu-item-icon" id="menu-theme-icon">üåô</span>
              <span id="menu-theme-text">Dark Mode</span>
            </button>
            <div class="user-menu-divider"></div>
            <button class="user-menu-item user-menu-item-danger" onclick="handleUserMenuAction('sign-out')">
              <span class="user-menu-item-icon">üö™</span>
              <span>Sign Out</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Menu Overlay -->
  <div class="menu-overlay" onclick="closeMenu()"></div>

  <!-- Slide-out Menu -->
  <nav class="slide-menu" id="slide-menu">
    <div class="menu-header">
      <h2>Menu</h2>
      <button class="menu-close-btn" onclick="closeMenu()" aria-label="Close menu">
        ‚úï
      </button>
    </div>
    <div class="menu-nav">
      <button class="menu-item" data-route="dashboard" onclick="navigateFromMenu('dashboard')">
        <span class="menu-item-icon">üìä</span>
        <span>Dashboard</span>
      </button>
      <button class="menu-item" data-route="contacts" onclick="navigateFromMenu('contacts')">
        <span class="menu-item-icon">üë•</span>
        <span>Contacts</span>
      </button>
      <button class="menu-item" data-route="activity" onclick="navigateFromMenu('activity')">
        <span class="menu-item-icon">üìÖ</span>
        <span>Activity</span>
      </button>
      <button class="menu-item" data-route="settings" onclick="navigateFromMenu('settings')">
        <span class="menu-item-icon">‚öôÔ∏è</span>
        <span>Settings</span>
      </button>
    </div>
  </nav>

  <!-- App container -->
  <div id="app"></div>

  <!-- Toast notifications container -->
  <div id="toast-container"></div>

  <!-- Interaction Modal -->
  <div id="interaction-modal" class="modal-overlay" onclick="if(event.target === this) closeInteractionModal()">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Log Interaction</h2>
        <button class="modal-close" onclick="closeInteractionModal()">√ó</button>
      </div>
      <div id="modal-content"></div>
    </div>
  </div>

  <script type="module">
    'use strict';

    /* VERSION: 2.14 */
    console.log('üî• Personal CRM v2.14 - Firebase Sync Edition');

    /* ===== FIREBASE IMPORTS & INITIALIZATION ===== */
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider,
      onAuthStateChanged,
      signOut 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      doc, 
      setDoc, 
      getDoc,
      onSnapshot,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB4nBZj7MpB2OVZcp1n1I_a3nBMD1734Is",
      authDomain: "personal-crm-31132.firebaseapp.com",
      projectId: "personal-crm-31132",
      storageBucket: "personal-crm-31132.firebasestorage.app",
      messagingSenderId: "9090875114",
      appId: "1:9090875114:web:7d34502f46b16456f32193"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Authentication state
    let currentUser = null;
    let unsubscribeSnapshot = null;

    /* ===== STATE & DATA MODEL ===== */

    const AppState = {
      contacts: [],
      interactions: [],
      currentView: 'dashboard',
      selectedContactId: null,
      linkedinData: [], // Reference database from LinkedIn CSV
      enrichmentConflicts: [] // Tracks contacts with data conflicts
    };

    /* ===== UTILITY FUNCTIONS ===== */

    // Generate UUID v4
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Date formatting
    // Parse YYYY-MM-DD string as local date (avoids timezone issues)
    function parseLocalDate(dateStr) {
      const [year, month, day] = dateStr.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function getLocalDateString(date = new Date()) {
      // Returns YYYY-MM-DD in local timezone
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getYesterdayString() {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      return getLocalDateString(yesterday);
    }

    function getTwoDaysAgoString() {
      const twoDaysAgo = new Date();
      twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
      return getLocalDateString(twoDaysAgo);
    }

    function formatDate(date) {
      const d = parseLocalDate(date);
      return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    
    function formatDateShort(date) {
      const d = typeof date === 'string' ? parseLocalDate(date) : date;
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const diffTime = d - now;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Tomorrow';
      if (diffDays < 7) return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function formatRelativeDate(date) {
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const then = parseLocalDate(date);
      const diffTime = then - now;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

      // Future dates
      if (diffDays > 0) {
        if (diffDays === 1) return 'Tomorrow';
        if (diffDays < 7) return `In ${diffDays} days`;
        if (diffDays < 30) return `In ${Math.floor(diffDays / 7)} weeks`;
        if (diffDays < 365) return `In ${Math.floor(diffDays / 30)} months`;
        return `In ${Math.floor(diffDays / 365)} years`;
      }

      // Past dates
      const daysAgo = Math.abs(diffDays);
      if (daysAgo === 0) return 'Today';
      if (daysAgo === 1) return 'Yesterday';
      if (daysAgo < 7) return `${daysAgo} days ago`;
      if (daysAgo < 30) return `${Math.floor(daysAgo / 7)} weeks ago`;
      if (daysAgo < 365) return `${Math.floor(daysAgo / 30)} months ago`;
      return `${Math.floor(daysAgo / 365)} years ago`;
    }

    function isFutureDate(date) {
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const then = parseLocalDate(date);
      return then > now;
    }
    
    // Check if contact has any future interactions planned
    function hasUpcomingInteraction(contactId) {
      const interactions = getInteractionsByContact(contactId);
      return interactions.some(interaction => isFutureDate(interaction.date));
    }
    
    // Get the next upcoming interaction for a contact (returns null if none)
    function getNextUpcomingInteraction(contactId) {
      const interactions = getInteractionsByContact(contactId);
      const upcomingInteractions = interactions.filter(interaction => isFutureDate(interaction.date));
      
      if (upcomingInteractions.length === 0) return null;
      
      // Sort by date (earliest first)
      upcomingInteractions.sort((a, b) => {
        const dateA = parseLocalDate(a.date);
        const dateB = parseLocalDate(b.date);
        return dateA - dateB;
      });
      
      return upcomingInteractions[0];
    }

    // Validation
    function validateEmail(email) {
      if (!email) return true; // Optional field
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function validatePhone(phone) {
      if (!phone) return true; // Optional field
      // Strip all non-digits and check for exactly 10 digits
      const digits = phone.replace(/\D/g, '');
      return digits.length === 10;
    }

    function formatPhoneNumber(value) {
      // Strip all non-digits
      const digits = value.replace(/\D/g, '');

      // Format as (###) ###-####
      if (digits.length === 0) return '';
      if (digits.length <= 3) return `(${digits}`;
      if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
      return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
    }

    // Toast notifications
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }


    /* ===== FIREBASE AUTHENTICATION ===== */

    async function handleGoogleSignIn() {
      try {
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        currentUser = result.user;
        showToast(`Welcome, ${result.user.displayName}!`, 'success');
      } catch (error) {
        console.error('Sign-in error:', error);
        showToast('Sign-in failed. Please try again.', 'error');
      }
    }

    async function handleSignOut() {
      try {
        // Unsubscribe from Firestore listener
        if (unsubscribeSnapshot) {
          unsubscribeSnapshot();
          unsubscribeSnapshot = null;
        }
        
        await signOut(auth);
        currentUser = null;
        
        // Clear local state
        AppState.contacts = [];
        AppState.interactions = [];
        AppState.linkedinData = [];
        AppState.enrichmentConflicts = [];
        
        showToast('Signed out successfully', 'success');
        renderCurrentView();
      } catch (error) {
        console.error('Sign-out error:', error);
        showToast('Sign-out failed', 'error');
      }
    }

    /* ===== FIREBASE STORAGE FUNCTIONS ===== */

    const STORAGE_KEYS = {
      contacts: 'crm_contacts',
      interactions: 'crm_interactions',
      version: 'crm_version',
      linkedinData: 'crm_linkedin_data',
      enrichmentConflicts: 'crm_enrichment_conflicts'
    };

    // Load data from Firestore
    async function loadState() {
      if (!currentUser) {
        console.log('No user logged in, skipping Firestore load');
        return;
      }

      try {
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
          const data = userDoc.data();
          AppState.contacts = data.contacts || [];
          AppState.interactions = data.interactions || [];
          AppState.linkedinData = data.linkedinData || [];
          AppState.enrichmentConflicts = data.enrichmentConflicts || [];
          console.log('Data loaded from Firestore');
        } else {
          console.log('No existing data in Firestore, starting fresh');
        }
      } catch (error) {
        console.error('Error loading data from Firestore:', error);
        showToast('Error loading data', 'error');
      }
    }

    // Save data to Firestore
    async function saveState() {
      if (!currentUser) {
        console.log('No user logged in, skipping Firestore save');
        return;
      }

      try {
        const userDocRef = doc(db, 'users', currentUser.uid);
        await setDoc(userDocRef, {
          contacts: AppState.contacts,
          interactions: AppState.interactions,
          linkedinData: AppState.linkedinData,
          enrichmentConflicts: AppState.enrichmentConflicts,
          version: '1.0',
          lastUpdated: new Date().toISOString()
        });
        console.log('Data saved to Firestore');
      } catch (error) {
        console.error('Error saving data to Firestore:', error);
        if (error.code === 'permission-denied') {
          showToast('Permission denied. Please check Firestore rules.', 'error');
        } else {
          showToast('Error saving data', 'error');
        }
      }
    }

    // Set up real-time sync
    function setupRealtimeSync() {
      if (!currentUser) return;

      const userDocRef = doc(db, 'users', currentUser.uid);
      
      unsubscribeSnapshot = onSnapshot(userDocRef, (doc) => {
        if (doc.exists()) {
          const data = doc.data();
          AppState.contacts = data.contacts || [];
          AppState.interactions = data.interactions || [];
          AppState.linkedinData = data.linkedinData || [];
          AppState.enrichmentConflicts = data.enrichmentConflicts || [];
          
          // Re-render current view to show updated data
          renderCurrentView();
          console.log('Data synced from Firestore');
        }
      }, (error) => {
        console.error('Snapshot error:', error);
      });
    }

    /* ===== DATA ACCESS LAYER - CONTACTS ===== */

    function getContacts() {
      return AppState.contacts;
    }

    function getContact(id) {
      return AppState.contacts.find(c => c.id === id);
    }

    function getDefaultContactFrequency(relationshipType) {
      // Default thresholds: Professional = 60 days, Personal (Friend/Close Friend/Family) = 30 days
      if (relationshipType === 'Professional') return 60;
      if (relationshipType === 'Close Friend' || relationshipType === 'Friend' || relationshipType === 'Family') return 30;
      return 60; // Default fallback
    }

    function getContactFrequency(contact) {
      // Return custom frequency if set, otherwise use default based on relationship type
      if (contact.contactFrequency !== undefined && contact.contactFrequency !== null) {
        return contact.contactFrequency;
      }
      return getDefaultContactFrequency(contact.relationshipType);
    }

    function addContact(contactData) {
      const contact = {
        id: generateUUID(),
        // New format: firstName and lastName
        firstName: contactData.firstName || '',
        lastName: contactData.lastName || '',
        // Keep old name field for backwards compatibility
        name: contactData.name || `${contactData.firstName || ''} ${contactData.lastName || ''}`.trim(),
        relationshipType: contactData.relationshipType,
        howWeMet: contactData.howWeMet || '',
        phone: contactData.phone || '',
        email: contactData.email || '',
        linkedin: contactData.linkedin || '',
        company: contactData.company || '',
        position: contactData.position || '',
        industry: contactData.industry || '',
        notes: contactData.notes || '',
        birthdayMonth: contactData.birthdayMonth || '',
        birthdayDay: contactData.birthdayDay || '',
        // Keep old birthday field for backwards compatibility
        birthday: contactData.birthday || '',
        priority: contactData.priority || false,
        muted: contactData.muted || false,
        contactFrequency: contactData.contactFrequency !== undefined ? contactData.contactFrequency : null, // null = use default
        createdAt: Date.now(),
        updatedAt: Date.now(),
        lastContactedAt: null
      };

      AppState.contacts.push(contact);
      
      // Auto-enrich if LinkedIn URL provided
      if (contact.linkedin) {
        autoEnrichContact(contact.id);
      }
      
      saveState();
      return contact;
    }

    // Helper function to get full name
    function getFullName(contact) {
      if (contact.firstName || contact.lastName) {
        return `${contact.firstName || ''} ${contact.lastName || ''}`.trim();
      }
      return contact.name || '';
    }

    // Helper function to get contact initials
    function getContactInitials(contact) {
      if (contact.firstName || contact.lastName) {
        const first = (contact.firstName || '').trim()[0] || '';
        const last = (contact.lastName || '').trim()[0] || '';
        return `${first}${last}`.toUpperCase();
      }
      // Fall back to name field
      const nameParts = (contact.name || '').trim().split(' ');
      if (nameParts.length >= 2) {
        return `${nameParts[0][0]}${nameParts[nameParts.length - 1][0]}`.toUpperCase();
      }
      return (contact.name || '?')[0].toUpperCase();
    }

    function updateContact(id, updates) {
      const index = AppState.contacts.findIndex(c => c.id === id);
      if (index === -1) return null;

      const oldLinkedIn = AppState.contacts[index].linkedin;
      
      AppState.contacts[index] = {
        ...AppState.contacts[index],
        ...updates,
        updatedAt: Date.now()
      };

      // Auto-enrich if LinkedIn URL was added or changed
      const newLinkedIn = AppState.contacts[index].linkedin;
      if (newLinkedIn && newLinkedIn !== oldLinkedIn) {
        autoEnrichContact(id);
      }

      saveState();
      return AppState.contacts[index];
    }

    function toggleContactPriority(id) {
      const contact = getContact(id);
      if (!contact) return;
      updateContact(id, { priority: !contact.priority });
      showToast(contact.priority ? 'Removed from Contact ASAP' : 'Added to Contact ASAP', 'success');
      renderCurrentView();
    }

    function toggleContactMuted(id) {
      const contact = getContact(id);
      if (!contact) return;
      updateContact(id, { muted: !contact.muted });
      showToast(contact.muted ? 'Contact unmuted' : 'Contact muted', 'success');
      renderCurrentView();
    }

    function deleteContact(id) {
      // Also delete all interactions for this contact
      AppState.interactions = AppState.interactions.filter(i => i.contactId !== id);
      AppState.contacts = AppState.contacts.filter(c => c.id !== id);
      saveState();
      return true;
    }

    /* ===== DATA ACCESS LAYER - INTERACTIONS ===== */

    function getInteractions() {
      return AppState.interactions;
    }

    function getInteractionsByContact(contactId) {
      return AppState.interactions
        .filter(i => i.contactId === contactId || (i.taggedContacts && i.taggedContacts.includes(contactId)))
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    function addInteraction(interactionData) {
      const interaction = {
        id: generateUUID(),
        contactId: interactionData.contactId,
        taggedContacts: interactionData.taggedContacts || [],
        date: interactionData.date,
        type: interactionData.type,
        notes: interactionData.notes || '',
        createdAt: Date.now()
      };

      AppState.interactions.push(interaction);
      updateContactLastInteraction(interaction.contactId);
      // Also update lastContactedAt for tagged contacts
      if (interaction.taggedContacts && interaction.taggedContacts.length > 0) {
        interaction.taggedContacts.forEach(taggedId => {
          updateContactLastInteraction(taggedId);
        });
      }
      saveState();
      return interaction;
    }

    function updateInteraction(id, updates) {
      const index = AppState.interactions.findIndex(i => i.id === id);
      if (index === -1) return null;

      const interaction = AppState.interactions[index];
      const oldTaggedContacts = interaction.taggedContacts || [];
      const newTaggedContacts = updates.taggedContacts || oldTaggedContacts;

      AppState.interactions[index] = {
        ...interaction,
        ...updates
      };

      // Update primary contact's last interaction
      updateContactLastInteraction(interaction.contactId);

      // Find contacts that were removed from tags and recalculate their lastContactedAt
      const removedContacts = oldTaggedContacts.filter(id => !newTaggedContacts.includes(id));
      const addedContacts = newTaggedContacts.filter(id => !oldTaggedContacts.includes(id));

      // Recalculate for removed contacts (they may have lost their most recent interaction)
      removedContacts.forEach(contactId => {
        updateContactLastInteraction(contactId);
      });

      // Update for newly added contacts
      addedContacts.forEach(contactId => {
        updateContactLastInteraction(contactId);
      });

      saveState();
      return AppState.interactions[index];
    }

    function deleteInteraction(id) {
      const interaction = AppState.interactions.find(i => i.id === id);
      if (!interaction) return false;

      const taggedContacts = interaction.taggedContacts || [];

      AppState.interactions = AppState.interactions.filter(i => i.id !== id);
      updateContactLastInteraction(interaction.contactId);

      // Also recalculate lastContactedAt for any tagged contacts
      taggedContacts.forEach(contactId => {
        updateContactLastInteraction(contactId);
      });

      saveState();
      return true;
    }

    function updateContactLastInteraction(contactId) {
      const interactions = getInteractionsByContact(contactId);

      if (interactions.length === 0) {
        updateContact(contactId, { lastContactedAt: null });
        return;
      }

      // Only consider past interactions (not future planned ones)
      const pastInteractions = interactions.filter(i => !isFutureDate(i.date));

      if (pastInteractions.length === 0) {
        updateContact(contactId, { lastContactedAt: null });
        return;
      }

      const mostRecent = pastInteractions.reduce((latest, current) => {
        const currentDate = parseLocalDate(current.date);
        return currentDate > latest ? currentDate : latest;
      }, new Date(0));

      updateContact(contactId, { lastContactedAt: mostRecent.getTime() });
    }

    // Recalculate lastContactedAt for all contacts (fixes stale data from before tag tracking)
    function recalculateAllLastContactedDates() {
      AppState.contacts.forEach(contact => {
        updateContactLastInteraction(contact.id);
      });
      saveState();
    }

    /* ===== CALCULATION FUNCTIONS ===== */

    function getDaysSinceLastContact(contactId) {
      const contact = getContact(contactId);
      if (!contact || !contact.lastContactedAt) return null;

      const now = new Date();
      const lastContact = new Date(contact.lastContactedAt);
      const diffTime = Math.abs(now - lastContact);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

      return diffDays;
    }

    function getContactStatus(contactId) {
      const days = getDaysSinceLastContact(contactId);

      if (days === null) return 'never';
      if (days < 14) return 'recent';
      if (days < 30) return 'caution';
      if (days < 60) return 'warning';
      return 'overdue';
    }

    function getUpcomingBirthdays(days = 30) {
      const today = new Date();
      // Normalize today to midnight for accurate date comparison
      today.setHours(0, 0, 0, 0);
      const upcoming = [];

      const monthMap = {
        'January': 0, 'February': 1, 'March': 2, 'April': 3, 'May': 4, 'June': 5,
        'July': 6, 'August': 7, 'September': 8, 'October': 9, 'November': 10, 'December': 11
      };

      AppState.contacts.forEach(contact => {
        let nextBirthday, monthNum, dayNum;

        // Handle new format (birthdayMonth and birthdayDay)
        if (contact.birthdayMonth && contact.birthdayDay) {
          monthNum = monthMap[contact.birthdayMonth];
          dayNum = parseInt(contact.birthdayDay);
        }
        // Handle old format (birthday as YYYY-MM-DD)
        else if (contact.birthday) {
          const [year, month, day] = contact.birthday.split('-').map(Number);
          monthNum = month - 1;
          dayNum = day;
        } else {
          return; // No birthday information
        }

        const currentYear = today.getFullYear();
        nextBirthday = new Date(currentYear, monthNum, dayNum);

        if (nextBirthday < today) {
          nextBirthday = new Date(currentYear + 1, monthNum, dayNum);
        }

        const daysUntil = Math.floor((nextBirthday - today) / (1000 * 60 * 60 * 24));

        if (daysUntil <= days && daysUntil >= 0) {
          upcoming.push({ contact, date: nextBirthday, daysUntil });
        }
      });

      return upcoming.sort((a, b) => a.daysUntil - b.daysUntil);
    }

    function getNeedsAttention() {
      return AppState.contacts
        .filter(c => {
          const days = getDaysSinceLastContact(c.id);
          return days === null || days >= 14;
        })
        .sort((a, b) => {
          const daysA = getDaysSinceLastContact(a.id) || 9999;
          const daysB = getDaysSinceLastContact(b.id) || 9999;
          return daysB - daysA;
        });
    }

    /* ===== ROUTER & NAVIGATION ===== */

    const Routes = {
      'dashboard': renderDashboard,
      'contacts': renderContactList,
      'activity': renderActivity,
      'add-contact': renderContactForm,
      'contact': renderContactDetail,
      'edit-contact': renderContactForm,
      'enrichment-conflicts': renderEnrichmentConflicts,
      'settings': renderSettings
    };

    function navigateTo(route, params = {}) {
      AppState.currentView = route;
      AppState.selectedContactId = params.id || null;

      if (params.id) {
        window.location.hash = `${route}/${params.id}`;
      } else {
        window.location.hash = route;
      }

      renderCurrentView();
      updateNavigation();
    }

    function handleHashChange() {
      const hash = window.location.hash.slice(1) || 'dashboard';
      const [route, id] = hash.split('/');

      AppState.currentView = route;
      AppState.selectedContactId = id || null;

      renderCurrentView();
      updateNavigation();
    }

    function renderCurrentView() {
      // Show login screen if not authenticated
      if (!currentUser) {
        renderLoginScreen();
        return;
      }

      const route = AppState.currentView;
      const renderer = Routes[route];

      if (renderer) {
        renderer();
      } else {
        navigateTo('dashboard');
      }
    }

    function updateNavigation() {
      updateMenuActiveState();
    }

    /* ===== VIEW RENDERERS ===== */

    function renderLoginScreen() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - var(--nav-height)); padding: 2rem;">
          <div style="max-width: 400px; text-align: center; background: var(--color-surface); padding: 3rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg);">
            <div style="font-size: 4rem; margin-bottom: 1.5rem;">üë•</div>
            <h1 style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--color-text-primary);">Welcome to Personal CRM</h1>
            <p style="color: var(--color-text-secondary); margin-bottom: 2rem;">Sign in to access your contacts and stay connected with people who matter.</p>
            <button 
              id="google-signin-btn"
              style="
                width: 100%;
                padding: 1rem;
                background: var(--color-primary);
                color: white;
                border: none;
                border-radius: var(--border-radius);
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s;
                box-shadow: var(--shadow-md);
              "
              onmouseover="this.style.background='var(--color-primary-light)'"
              onmouseout="this.style.background='var(--color-primary)'"
            >
              üîê Sign in with Google
            </button>
            <p style="margin-top: 2rem; font-size: 0.875rem; color: var(--color-text-secondary);">
              Your data is securely stored and synced across all your devices.
            </p>
          </div>
        </div>
      `;
      
      // Attach event listener after DOM is created
      setTimeout(() => {
        const btn = document.getElementById('google-signin-btn');
        if (btn) {
          btn.addEventListener('click', handleGoogleSignIn);
        }
      }, 0);
    }

    function renderDashboard() {
      const app = document.getElementById('app');

      const totalContacts = AppState.contacts.length;
      const professionalContacts = AppState.contacts.filter(c => c.relationshipType === 'Professional').length;
      const personalContacts = AppState.contacts.filter(c => c.relationshipType !== 'Professional').length;
      const totalInteractions = AppState.interactions.length;

      // Priority contacts sorted by longest time since last contact
      const priorityContacts = AppState.contacts
        .filter(c => c.priority)
        .sort((a, b) => {
          const daysA = getDaysSinceLastContact(a.id) ?? 9999;
          const daysB = getDaysSinceLastContact(b.id) ?? 9999;
          return daysB - daysA;
        });

      // Needs Attention - Professional (uses contact's frequency setting, not muted)
      const needsAttentionProfessional = AppState.contacts
        .filter(c => {
          if (c.muted) return false;
          if (c.relationshipType !== 'Professional') return false;
          const days = getDaysSinceLastContact(c.id);
          const threshold = getContactFrequency(c);
          return days === null || days >= threshold;
        })
        .sort((a, b) => {
          const daysA = getDaysSinceLastContact(a.id) ?? 9999;
          const daysB = getDaysSinceLastContact(b.id) ?? 9999;
          return daysB - daysA;
        });

      // Needs Attention - Personal (Close Friend, Friend, or Family - uses contact's frequency setting, not muted)
      const needsAttentionPersonal = AppState.contacts
        .filter(c => {
          if (c.muted) return false;
          if (c.relationshipType !== 'Close Friend' && c.relationshipType !== 'Friend' && c.relationshipType !== 'Family') return false;
          const days = getDaysSinceLastContact(c.id);
          const threshold = getContactFrequency(c);
          return days === null || days >= threshold;
        })
        .sort((a, b) => {
          const daysA = getDaysSinceLastContact(a.id) ?? 9999;
          const daysB = getDaysSinceLastContact(b.id) ?? 9999;
          return daysB - daysA;
        });

      const upcomingBirthdays = getUpcomingBirthdays(30);

      // Calculate L7D (last 7 days) interactions
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      sevenDaysAgo.setHours(0, 0, 0, 0);
      const l7dInteractions = AppState.interactions.filter(i => {
        const interactionDate = parseLocalDate(i.date);
        return interactionDate >= sevenDaysAgo && !isFutureDate(i.date);
      }).length;

      // Calculate YTD (year-to-date) interactions
      const startOfYear = new Date(new Date().getFullYear(), 0, 1);
      startOfYear.setHours(0, 0, 0, 0);
      const ytdInteractions = AppState.interactions.filter(i => {
        const interactionDate = parseLocalDate(i.date);
        return interactionDate >= startOfYear && !isFutureDate(i.date);
      }).length;

      // Split interactions into past (recent) and future (upcoming) using local date comparison
      const recentInteractions = AppState.interactions
        .filter(i => !isFutureDate(i.date))
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 20);
      const upcomingInteractions = AppState.interactions
        .filter(i => isFutureDate(i.date))
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 5);

      if (totalContacts === 0) {
        app.innerHTML = `
          <div class="view">
            <div class="page-header">
              <div class="content-container">
                <div class="view-header">
                  <h1 class="view-title">Dashboard</h1>
                </div>
              </div>
            </div>
            <div class="content-container">
              <div class="empty-state">
                <div class="empty-state-icon" style="font-size: 2rem; color: var(--color-primary);">üëã</div>
                <h2>Welcome to Relationship CRM</h2>
                <p class="text-muted">Keep track of your personal and professional relationships.</p>
                <p class="text-muted text-small">Start by adding your first contact, then log interactions to stay connected.</p>
                <button class="btn mt-md" onclick="navigateTo('add-contact')">Add Your First Contact</button>
              </div>
            </div>
          </div>
        `;
        return;
      }

      app.innerHTML = `
        <div class="view">
          <div class="page-header">
            <div class="content-container">
              <div class="view-header">
                <h1 class="view-title">Dashboard</h1>
              </div>
            </div>
          </div>

          <div class="content-container">
          <div class="dashboard-new-grid">
            <!-- Priority Contacts -->
            <div class="card card-priority" style="margin-bottom: 0; ${priorityContacts.length > 0 ? 'border-left: 3px solid var(--color-danger); background: linear-gradient(to right, rgba(239, 68, 68, 0.05), transparent);' : 'opacity: 0.6;'}">
              <h2 class="section-title">
                <span style="background: ${priorityContacts.length > 0 ? 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)' : '#F3F4F6'}; color: ${priorityContacts.length > 0 ? 'white' : '#6B7280'}; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">PRIORITY</span>
                <span>Contact ASAP</span>
              </h2>
              ${priorityContacts.length > 0 ? `
                <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto; padding-right: 0.5rem;">
                  ${priorityContacts.map(contact => {
                    const days = getDaysSinceLastContact(contact.id);
                    const status = getContactStatus(contact.id);
                    const statusTextFull = days === null ? 'Never contacted' : `${days} days`;
                    const statusTextShort = days === null ? '‚Äî' : `${days}`;
                    return `
                      <div class="card card-clickable priority-contact-card" style="padding: 0.5rem 0.75rem; margin: 0; border-left: 3px solid var(--color-${status}); flex-shrink: 0;" onclick="navigateTo('contact', {id: '${contact.id}'})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <div style="min-width: 0; flex: 1;">
                            <div style="font-weight: 600; font-size: 0.8125rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(getFullName(contact))}</div>
                            <div class="text-muted priority-contact-type" style="font-size: 0.8125rem;">${contact.relationshipType}</div>
                          </div>
                          <div style="color: var(--color-${status}); font-weight: 600; font-size: 0.8125rem; white-space: nowrap; margin-left: 0.5rem;">
                            <span class="status-full">${statusTextFull}</span>
                            <span class="status-short">${statusTextShort}</span>
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : '<p class="text-muted" style="font-size: 0.8125rem;">No priority contacts. Mark someone as priority from their contact page to see them here.</p>'}
            </div>

            <!-- Needs Attention -->
            <div class="card card-attention" style="margin-bottom: 0; ${(needsAttentionProfessional.length > 0 || needsAttentionPersonal.length > 0) ? 'border-left: 3px solid var(--color-warning);' : 'opacity: 0.6;'}">
              <h2 class="section-title">Needs Attention</h2>
              ${(needsAttentionProfessional.length > 0 || needsAttentionPersonal.length > 0) ? `
                <div class="needs-attention-grid">
                  <!-- Professional Column -->
                  <div style="${needsAttentionProfessional.length === 0 ? 'opacity: 0.5;' : ''}">
                    <h3 style="font-size: 0.8125rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 0.5rem; padding-bottom: 0.375rem; border-bottom: 2px solid var(--color-primary);">
                      Professional ${needsAttentionProfessional.length > 0 ? `(${needsAttentionProfessional.length})` : ''}
                    </h3>
                    ${needsAttentionProfessional.length > 0 ? `
                      <div style="display: flex; flex-direction: column; gap: 0.375rem; max-height: 160px; overflow-y: auto; padding-right: 0.5rem;">
                        ${needsAttentionProfessional.map(contact => {
                          const days = getDaysSinceLastContact(contact.id);
                          const status = getContactStatus(contact.id);
                          const statusText = days === null ? 'Never' : `${days}d`;
                          const hasUpcoming = hasUpcomingInteraction(contact.id);
                          return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.375rem 0.5rem; background: var(--color-background); border-radius: 0.5rem; cursor: pointer; flex-shrink: 0; ${hasUpcoming ? 'opacity: 0.6;' : ''}" onclick="navigateTo('contact', {id: '${contact.id}'})">
                              <div style="min-width: 0; flex: 1;">
                                <div style="font-weight: 600; font-size: 0.8125rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; ${hasUpcoming ? 'color: var(--color-text-secondary);' : ''}">${escapeHtml(getFullName(contact))}</div>
                              </div>
                              <div style="font-size: 0.8125rem; font-weight: 600; color: var(--color-${status}); margin-left: 0.5rem; white-space: nowrap; ${hasUpcoming ? 'opacity: 0.7;' : ''}">
                                ${hasUpcoming ? 'üìÖ ' : ''}${statusText}
                              </div>
                            </div>
                          `;
                        }).join('')}
                      </div>
                    ` : '<p class="text-muted" style="font-size: 0.8125rem;">All caught up!</p>'}
                  </div>
                  <!-- Personal Column -->
                  <div style="${needsAttentionPersonal.length === 0 ? 'opacity: 0.5;' : ''}">
                    <h3 style="font-size: 0.8125rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 0.5rem; padding-bottom: 0.375rem; border-bottom: 2px solid var(--color-primary);">
                      Personal ${needsAttentionPersonal.length > 0 ? `(${needsAttentionPersonal.length})` : ''}
                    </h3>
                    ${needsAttentionPersonal.length > 0 ? `
                      <div style="display: flex; flex-direction: column; gap: 0.375rem; max-height: 160px; overflow-y: auto; padding-right: 0.5rem;">
                        ${needsAttentionPersonal.map(contact => {
                          const days = getDaysSinceLastContact(contact.id);
                          const status = getContactStatus(contact.id);
                          const statusText = days === null ? 'Never' : `${days}d`;
                          const hasUpcoming = hasUpcomingInteraction(contact.id);
                          return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.375rem 0.5rem; background: var(--color-background); border-radius: 0.5rem; cursor: pointer; flex-shrink: 0; ${hasUpcoming ? 'opacity: 0.6;' : ''}" onclick="navigateTo('contact', {id: '${contact.id}'})">
                              <div style="min-width: 0; flex: 1;">
                                <div style="font-weight: 600; font-size: 0.8125rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; ${hasUpcoming ? 'color: var(--color-text-secondary);' : ''}">${escapeHtml(getFullName(contact))}</div>
                              </div>
                              <div style="font-size: 0.8125rem; font-weight: 600; color: var(--color-${status}); margin-left: 0.5rem; white-space: nowrap; ${hasUpcoming ? 'opacity: 0.7;' : ''}">
                                ${hasUpcoming ? 'üìÖ ' : ''}${statusText}
                              </div>
                            </div>
                          `;
                        }).join('')}
                      </div>
                    ` : '<p class="text-muted text-small">All caught up!</p>'}
                  </div>
                </div>
              ` : '<p class="text-muted text-small">All caught up! Great job staying connected with your network.</p>'}
            </div>

            <!-- Activity Column (spans vertically) -->
            <div class="card card-activity" style="margin-bottom: 0;">
              <h2 class="section-title">Activity</h2>

              <div class="activity-scroll">
                <!-- Upcoming Activity -->
                ${upcomingInteractions.length > 0 ? `
                  <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 0.8125rem; font-weight: 600; color: var(--color-primary); margin-bottom: 0.5rem;">Upcoming</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                      ${upcomingInteractions.slice(0, 5).map(interaction => {
                        const contact = getContact(interaction.contactId);
                        const notePreview = interaction.notes ? (interaction.notes.length > 60 ? interaction.notes.substring(0, 60) + '...' : interaction.notes) : '';
                        // Build participant list including tagged contacts
                        const participants = [getFullName(contact)];
                        if (interaction.taggedContacts && interaction.taggedContacts.length > 0) {
                          interaction.taggedContacts.forEach(taggedId => {
                            const taggedContact = getContact(taggedId);
                            if (taggedContact) participants.push(getFullName(taggedContact));
                          });
                        }
                        const participantText = participants.length > 2
                          ? participants.slice(0, 2).map(n => escapeHtml(n)).join(', ') + ` +${participants.length - 2}`
                          : participants.map(n => escapeHtml(n)).join(' & ');
                        const fullParticipantText = participants.map(n => escapeHtml(n)).join(', ');
                        return `
                          <div class="activity-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.375rem 0.5rem; background: rgba(37, 99, 235, 0.05); border-radius: 0.5rem; cursor: pointer; border-left: 2px dashed var(--color-primary);" onclick="navigateTo('contact', {id: '${contact.id}'})">
                            <div style="min-width: 0; flex: 1;">
                              <div style="font-weight: 600; font-size: 0.8125rem; color: var(--color-primary);">${interaction.type} with ${participantText}</div>
                              <div class="text-muted" style="font-size: 0.8125rem;">${formatDate(interaction.date)}</div>
                            </div>
                            ${notePreview || participants.length > 2 ? `
                              <div class="activity-tooltip">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${interaction.type} with ${fullParticipantText}</div>
                                <div class="text-muted" style="margin-bottom: 0.5rem;">${formatDate(interaction.date)}</div>
                                ${interaction.notes ? `<div>${escapeHtml(interaction.notes)}</div>` : ''}
                              </div>
                            ` : ''}
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                ` : ''}

                <!-- Recent Activity -->
                ${recentInteractions.length > 0 ? `
                  <div>
                    <h3 style="font-size: 0.8125rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 0.5rem;">Recent</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                      ${recentInteractions.slice(0, 20).map(interaction => {
                        const contact = getContact(interaction.contactId);
                        const status = getContactStatus(contact.id);
                        const notePreview = interaction.notes ? (interaction.notes.length > 60 ? interaction.notes.substring(0, 60) + '...' : interaction.notes) : '';
                        // Build participant list including tagged contacts
                        const participants = [getFullName(contact)];
                        if (interaction.taggedContacts && interaction.taggedContacts.length > 0) {
                          interaction.taggedContacts.forEach(taggedId => {
                            const taggedContact = getContact(taggedId);
                            if (taggedContact) participants.push(getFullName(taggedContact));
                          });
                        }
                        const participantText = participants.length > 2
                          ? participants.slice(0, 2).map(n => escapeHtml(n)).join(', ') + ` +${participants.length - 2}`
                          : participants.map(n => escapeHtml(n)).join(' & ');
                        const fullParticipantText = participants.map(n => escapeHtml(n)).join(', ');
                        return `
                          <div class="activity-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.375rem 0.5rem; background: var(--color-background); border-radius: 0.5rem; cursor: pointer;" onclick="navigateTo('contact', {id: '${contact.id}'})">
                            <div style="min-width: 0; flex: 1;">
                              <div style="font-weight: 600; font-size: 0.8125rem;">${interaction.type} with ${participantText}</div>
                              <div class="text-muted" style="font-size: 0.8125rem;">${formatRelativeDate(interaction.date)}</div>
                            </div>
                            ${notePreview || participants.length > 2 ? `
                              <div class="activity-tooltip">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${interaction.type} with ${fullParticipantText}</div>
                                <div class="text-muted" style="margin-bottom: 0.5rem;">${formatRelativeDate(interaction.date)}</div>
                                ${interaction.notes ? `<div>${escapeHtml(interaction.notes)}</div>` : ''}
                              </div>
                            ` : ''}
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                ` : ''}

                ${upcomingInteractions.length === 0 && recentInteractions.length === 0 ? `
                  <p class="text-muted text-small">No activity yet. Log an interaction from any contact's page to start tracking.</p>
                ` : ''}
              </div>
            </div>

            <!-- Upcoming Birthdays Card -->
            <div class="card card-birthdays" style="margin-bottom: 0;">
              <h2 class="section-title">
                <span style="font-size: 1rem;">üéÇ</span>
                <span>Upcoming Birthdays</span>
              </h2>
              ${(() => {
                const nextBirthdays = getUpcomingBirthdays(365).slice(0, 3);
                if (nextBirthdays.length === 0) {
                  return '<p class="text-muted" style="font-size: 0.8125rem;">No birthdays on file. Add birthday info when editing a contact to see reminders here.</p>';
                }
                return `
                  <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                    ${nextBirthdays.map(({ contact, daysUntil }) => {
                      const dayText = daysUntil === 0 ? 'Today!' : daysUntil === 1 ? 'Tomorrow' : `${daysUntil}d`;
                      const birthdayText = contact.birthdayMonth && contact.birthdayDay ? `${contact.birthdayMonth.slice(0, 3)} ${contact.birthdayDay}` : '';
                      const isUrgent = daysUntil <= 7;
                      return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0; cursor: pointer;" onclick="navigateTo('contact', {id: '${contact.id}'})">
                          <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; font-size: 0.8125rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(getFullName(contact))}</div>
                            <div class="text-muted" style="font-size: 0.8125rem;">${birthdayText}</div>
                          </div>
                          <div style="font-size: 0.8125rem; font-weight: 600; color: ${isUrgent ? 'var(--color-danger)' : 'var(--color-primary)'}; white-space: nowrap; margin-left: 0.5rem;">
                            ${dayText}
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                `;
              })()}
            </div>

            <!-- Quick Stats Card -->
            <div class="card card-stats" style="margin-bottom: 0;">
              <h2 class="section-title">Quick Stats</h2>
              <!-- Contacts -->
              <div style="margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-border-light);">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                  <div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">${totalContacts}</div>
                    <div class="text-muted" style="font-size: 0.8125rem;">Total Contacts</div>
                  </div>
                  <div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">${professionalContacts}</div>
                    <div class="text-muted" style="font-size: 0.8125rem;">Professional</div>
                  </div>
                  <div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">${personalContacts}</div>
                    <div class="text-muted" style="font-size: 0.8125rem;">Personal</div>
                  </div>
                </div>
              </div>
              <!-- Interactions breakdown -->
              <div class="text-muted" style="font-size: 0.8125rem; margin-bottom: 0.375rem; font-weight: 600;">Interactions</div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                <div>
                  <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">${totalInteractions}</div>
                  <div class="text-muted" style="font-size: 0.8125rem;">Total</div>
                </div>
                <div>
                  <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">${ytdInteractions}</div>
                  <div class="text-muted" style="font-size: 0.8125rem;">YTD</div>
                </div>
                <div>
                  <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">${l7dInteractions}</div>
                  <div class="text-muted" style="font-size: 0.8125rem;">L7D</div>
                </div>
              </div>
            </div>
          </div>
          </div>
        </div>
      `;
    }

    function getInteractionIcon(type) {
      const icons = {
        'Call': '‚òéÔ∏è',
        'Text': 'üì±',
        'Email': '‚úâÔ∏è',
        'In-Person': 'ü§ù',
        'Video': 'üñ•Ô∏è',
        'LinkedIn': 'ü§µ',
        'Social': 'ü§µ' // Legacy support
      };
      return icons[type] || 'üì±';
    }

    function getInteractionIconClass(type) {
      const iconClasses = {
        'Call': 'icon-call',
        'Text': 'icon-text',
        'Email': 'icon-email',
        'In-Person': 'icon-inperson',
        'Video': 'icon-video',
        'LinkedIn': 'icon-linkedin',
        'Social': 'icon-linkedin' // Legacy support
      };
      return iconClasses[type] || 'icon-text';
    }

    function getInteractionIconText(type) {
      const iconTexts = {
        'Call': 'C',
        'Text': 'T',
        'Email': 'E',
        'In-Person': 'P',
        'Video': 'V',
        'LinkedIn': 'L',
        'Social': 'L' // Legacy support
      };
      return iconTexts[type] || 'I';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Store filter state for contacts page
    let contactFilterState = {
      searchQuery: '',
      filterTypes: [], // Empty array means all types
      sortBy: 'name-asc'
    };

    function toggleFilterType(type) {
      const idx = contactFilterState.filterTypes.indexOf(type);
      if (idx === -1) {
        contactFilterState.filterTypes.push(type);
      } else {
        contactFilterState.filterTypes.splice(idx, 1);
      }
      renderContactList();
    }

    function renderContactList(searchQuery, filterTypes, sortBy) {
      // Update state if parameters are provided
      if (searchQuery !== undefined) contactFilterState.searchQuery = searchQuery;
      if (filterTypes !== undefined) contactFilterState.filterTypes = filterTypes;
      if (sortBy !== undefined) contactFilterState.sortBy = sortBy;

      const app = document.getElementById('app');

      if (AppState.contacts.length === 0) {
        app.innerHTML = `
          <div class="view">
            <div class="page-header">
              <div class="content-container">
                <div class="view-header">
                  <h1 class="view-title">Contacts</h1>
                </div>
              </div>
            </div>
            <div class="content-container">
              <div class="empty-state">
                <div class="empty-state-icon" style="font-size: 2rem; color: var(--color-primary);">üìá</div>
                <h2>No Contacts Yet</h2>
                <p class="text-muted">Your contact list is empty. Add people you want to stay in touch with.</p>
                <button class="btn mt-md" onclick="navigateTo('add-contact')">Add Your First Contact</button>
              </div>
            </div>
          </div>
        `;
        return;
      }

      // Filter and sort contacts
      let contacts = [...AppState.contacts];

      // Apply search filter
      if (contactFilterState.searchQuery) {
        const query = contactFilterState.searchQuery.toLowerCase();
        contacts = contacts.filter(c =>
          getFullName(c).toLowerCase().includes(query) ||
          c.email?.toLowerCase().includes(query) ||
          c.phone?.includes(query)
        );
      }

      // Apply relationship type filter (multi-select)
      if (contactFilterState.filterTypes.length > 0) {
        contacts = contacts.filter(c => contactFilterState.filterTypes.includes(c.relationshipType));
      }

      // Apply sorting
      const currentSort = contactFilterState.sortBy;
      if (currentSort === 'name-asc') {
        contacts.sort((a, b) => getFullName(a).localeCompare(getFullName(b)));
      } else if (currentSort === 'name-desc') {
        contacts.sort((a, b) => getFullName(b).localeCompare(getFullName(a)));
      } else if (currentSort === 'lastContacted-asc') {
        contacts.sort((a, b) => {
          const daysA = getDaysSinceLastContact(a.id) ?? 9999;
          const daysB = getDaysSinceLastContact(b.id) ?? 9999;
          return daysA - daysB;
        });
      } else if (currentSort === 'lastContacted-desc') {
        contacts.sort((a, b) => {
          const daysA = getDaysSinceLastContact(a.id) ?? 9999;
          const daysB = getDaysSinceLastContact(b.id) ?? 9999;
          return daysB - daysA;
        });
      } else if (currentSort === 'relationship-asc') {
        const order = ['Family', 'Close Friend', 'Friend', 'Professional', 'Acquaintance'];
        contacts.sort((a, b) => order.indexOf(a.relationshipType) - order.indexOf(b.relationshipType));
      } else if (currentSort === 'relationship-desc') {
        const order = ['Family', 'Close Friend', 'Friend', 'Professional', 'Acquaintance'];
        contacts.sort((a, b) => order.indexOf(b.relationshipType) - order.indexOf(a.relationshipType));
      }

      const relationshipTypes = ['Family', 'Close Friend', 'Friend', 'Professional', 'Acquaintance'];

      app.innerHTML = `
        <div class="view">
          <div class="page-header">
            <div class="content-container">
              <div class="view-header">
                <h1 class="view-title">Contacts (${AppState.contacts.length})</h1>
              </div>
            </div>
          </div>

          <div class="content-container">
          ${AppState.enrichmentConflicts.length > 0 ? `
            <div style="padding: var(--spacing-md); background: #FEF3C7; border: 1px solid #FCD34D; border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
              <div style="display: flex; align-items: center; gap: 0.5rem; color: #92400E; font-weight: 600; margin-bottom: 0.25rem;">
                <span>‚ö†Ô∏è</span> ${AppState.enrichmentConflicts.length} contact(s) have data conflicts
              </div>
              <div style="font-size: 0.875rem; color: #78350F; margin-bottom: 0.5rem;">
                LinkedIn data differs from your current information. Review and resolve conflicts.
              </div>
              <button class="btn btn-small" onclick="navigateTo('enrichment-conflicts')" style="font-size: 0.875rem; padding: 0.375rem 0.75rem; min-height: 32px;">
                Review Conflicts
              </button>
            </div>
          ` : ''}

          <!-- Search Bar -->
          <div class="form-group">
            <input
              type="search"
              class="form-input"
              placeholder="Search contacts..."
              value="${escapeHtml(contactFilterState.searchQuery)}"
              oninput="renderContactList(this.value)"
            />
          </div>

          <!-- Filter Chips and Sort Dropdown -->
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <div class="filter-chips" style="margin-bottom: 0; flex: 1; min-width: 0;">
              ${relationshipTypes.map(type => `
                <button
                  type="button"
                  class="filter-chip ${contactFilterState.filterTypes.includes(type) ? 'selected' : ''}"
                  onclick="toggleFilterType('${type}')"
                >${type}</button>
              `).join('')}
            </div>
            <select class="form-select" style="width: auto; min-width: 160px; min-height: 40px; padding: 0.5rem 2.25rem 0.5rem 0.75rem;" onchange="renderContactList(undefined, undefined, this.value)">
              <option value="name-asc" ${currentSort === 'name-asc' ? 'selected' : ''}>Name: A‚ÜíZ</option>
              <option value="name-desc" ${currentSort === 'name-desc' ? 'selected' : ''}>Name: Z‚ÜíA</option>
              <option value="lastContacted-desc" ${currentSort === 'lastContacted-desc' ? 'selected' : ''}>Oldest First</option>
              <option value="lastContacted-asc" ${currentSort === 'lastContacted-asc' ? 'selected' : ''}>Recent First</option>
              <option value="relationship-asc" ${currentSort === 'relationship-asc' ? 'selected' : ''}>Family First</option>
              <option value="relationship-desc" ${currentSort === 'relationship-desc' ? 'selected' : ''}>Acquaintance First</option>
            </select>
          </div>

          <!-- Contact List -->
          ${contacts.length === 0 ? `
            <div class="empty-state">
              <div class="empty-state-icon" style="font-size: 1.5rem; color: var(--color-text-secondary);">üîç</div>
              <p>No contacts match your search.</p>
              <p class="text-muted text-small">Try a different name, relationship type, or industry.</p>
            </div>
          ` : `
            <div class="contact-grid">
              ${contacts.map(contact => {
                const days = getDaysSinceLastContact(contact.id);
                const status = getContactStatus(contact.id);
                const statusText = days === null ? 'Never' : days === 0 ? 'Today' : days === 1 ? '1d' : `${days}d`;
                const priorityStyle = contact.priority ? 'background: linear-gradient(to right, rgba(239, 68, 68, 0.08), transparent);' : '';
                const upcomingInteraction = getNextUpcomingInteraction(contact.id);
                
                // Build tooltip text for upcoming interaction
                let tooltipText = '';
                if (upcomingInteraction) {
                  const interactionDate = parseLocalDate(upcomingInteraction.date);
                  const dateStr = formatDateShort(interactionDate);
                  const typeEmoji = upcomingInteraction.type === 'Call' ? '‚òéÔ∏è' :
                                   upcomingInteraction.type === 'Text' ? 'üì±' :
                                   upcomingInteraction.type === 'Email' ? '‚úâÔ∏è' :
                                   upcomingInteraction.type === 'In-Person' ? 'ü§ù' :
                                   upcomingInteraction.type === 'Video' ? 'üñ•Ô∏è' :
                                   upcomingInteraction.type === 'LinkedIn' ? 'ü§µ' : '';
                  
                  // Build participant list
                  const participants = [getFullName(contact)];
                  if (upcomingInteraction.taggedContacts && upcomingInteraction.taggedContacts.length > 0) {
                    upcomingInteraction.taggedContacts.forEach(taggedId => {
                      const taggedContact = getContact(taggedId);
                      if (taggedContact) participants.push(getFullName(taggedContact));
                    });
                  }
                  
                  tooltipText = `${typeEmoji} ${upcomingInteraction.type} with ${participants.join(' & ')} on ${dateStr}`;
                  
                  // Add notes if they exist
                  if (upcomingInteraction.notes && upcomingInteraction.notes.trim()) {
                    tooltipText += `: ${upcomingInteraction.notes}`;
                  }
                  
                  // Truncate if too long (150 chars to allow for more detail)
                  if (tooltipText.length > 150) {
                    tooltipText = tooltipText.substring(0, 147) + '...';
                  }
                }

                return `
                  <div class="card card-clickable contact-card-compact" style="border-left: 3px solid var(--color-${status}); margin: 0; ${priorityStyle}" onclick="navigateTo('contact', {id: '${contact.id}'})">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
                      <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.125rem;">
                          <span class="status-dot status-${status}"></span>
                          <span class="contact-name" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(getFullName(contact))}</span>
                          ${contact.priority ? `<span style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white; padding: 0.0625rem 0.375rem; border-radius: 0.25rem; font-size: 0.625rem; font-weight: 700; white-space: nowrap;">ASAP</span>` : ''}
                          ${contact.muted ? `<span style="color: var(--color-text-secondary); font-size: 0.75rem;" title="Muted">üîá</span>` : ''}
                        </div>
                        <div class="contact-meta text-muted">${contact.relationshipType}</div>
                      </div>
                      <div style="text-align: right; white-space: nowrap; position: relative;">
                        <div class="contact-meta" style="color: var(--color-${status}); font-weight: 600; display: inline-flex; align-items: center; gap: 0.25rem;">
                          ${upcomingInteraction ? `<span class="upcoming-indicator" onclick="event.stopPropagation();">üìÖ<span class="upcoming-tooltip">${escapeHtml(tooltipText)}</span></span>` : ''}
                          ${statusText}
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `}
          </div>
          
          <!-- Floating Action Button -->
          <button class="fab" onclick="navigateTo('add-contact')" aria-label="Add contact" title="Add Contact">
            <span style="display: block; transform: translateY(-1px);">+</span>
          </button>
        </div>
      `;
    }

    function renderActivity() {
      const app = document.getElementById('app');

      if (AppState.interactions.length === 0) {
        app.innerHTML = `
          <div class="view">
            <div class="page-header">
              <div class="content-container">
                <div class="view-header">
                  <h1 class="view-title">Activity</h1>
                </div>
              </div>
            </div>
            <div class="content-container">
              <div class="empty-state">
                <div class="empty-state-icon" style="font-size: 2rem; color: var(--color-primary);">üìÖ</div>
                <h2>No Activity Yet</h2>
                <p class="text-muted">Your activity timeline is empty. Log interactions with your contacts to see them here.</p>
                <p class="text-muted text-small">Go to any contact's page and click "Log Interaction" to get started.</p>
                <button class="btn mt-md" onclick="navigateTo('contacts')">View Contacts</button>
              </div>
            </div>
          </div>
        `;
        return;
      }

      // Get all interactions with contact info, sorted by date (most recent first)
      const allInteractions = AppState.interactions
        .map(interaction => ({
          ...interaction,
          contact: getContact(interaction.contactId)
        }))
        .filter(item => item.contact) // Filter out interactions for deleted contacts
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      // Group interactions by date
      const groupedByDate = {};
      allInteractions.forEach(interaction => {
        const dateKey = interaction.date;
        if (!groupedByDate[dateKey]) {
          groupedByDate[dateKey] = [];
        }
        groupedByDate[dateKey].push(interaction);
      });

      const dates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

      app.innerHTML = `
        <div class="view">
          <div class="page-header">
            <div class="content-container">
              <div class="view-header">
                <h1 class="view-title">Activity</h1>
              </div>
            </div>
          </div>

          <div class="content-container">
          <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            ${dates.map(date => {
              const interactions = groupedByDate[date];
              const dateObj = new Date(date + 'T00:00:00');
              const isToday = date === getLocalDateString();
              const isYesterday = date === getYesterdayString();

              let dateLabel;
              if (isToday) {
                dateLabel = 'Today';
              } else if (isYesterday) {
                dateLabel = 'Yesterday';
              } else {
                dateLabel = formatDate(date);
              }

              return `
                <div>
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <h2 style="font-size: 1.1rem; font-weight: 600; color: var(--color-primary);">${dateLabel}</h2>
                    <div style="flex: 1; height: 1px; background: var(--color-border);"></div>
                    <span class="text-muted text-small">${interactions.length} interaction${interactions.length > 1 ? 's' : ''}</span>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    ${interactions.map(interaction => {
                      const initials = getContactInitials(interaction.contact);
                      const status = getContactStatus(interaction.contact.id);
                      const isFuture = isFutureDate(interaction.date);
                      const borderStyle = isFuture ? 'border-left: 3px solid var(--color-primary); background: linear-gradient(to right, rgba(37, 99, 235, 0.05), transparent);' : '';
                      const typeLabel = isFuture ? `Planned: ${interaction.type}` : interaction.type;
                      return `
                        <div class="card card-clickable" style="padding: 1rem; margin: 0; ${borderStyle}" onclick="navigateTo('contact', {id: '${interaction.contact.id}'})">
                          <div style="display: flex; gap: 0.75rem; align-items: start;">
                            <span class="icon icon-${status}" style="background: linear-gradient(135deg, var(--color-${status}) 0%, var(--color-${status}) 100%); color: white; font-size: 0.875rem; font-weight: 700; ${isFuture ? 'opacity: 0.7; border: 2px dashed var(--color-primary);' : ''}">${initials}</span>
                            <div style="flex: 1;">
                              <div style="font-weight: 600; margin-bottom: 0.25rem; ${isFuture ? 'color: var(--color-primary);' : ''}">
                                ${typeLabel} with ${escapeHtml(getFullName(interaction.contact))}
                              </div>
                              <div class="text-muted text-small">${interaction.contact.relationshipType}</div>
                              ${interaction.notes ? `<div class="text-small" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--color-border);">${escapeHtml(interaction.notes)}</div>` : ''}
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          </div>
        </div>
      `;
    }

    function renderContactDetail() {
      const app = document.getElementById('app');
      const contact = getContact(AppState.selectedContactId);

      if (!contact) {
        app.innerHTML = `
          <div class="view">
            <div class="empty-state">
              <div class="empty-state-icon" style="font-size: 2rem; color: var(--color-danger);">Not Found</div>
              <h2>Contact Not Found</h2>
              <button class="btn mt-md" onclick="navigateTo('contacts')">Back to Contacts</button>
            </div>
          </div>
        `;
        return;
      }

      const days = getDaysSinceLastContact(contact.id);
      const status = getContactStatus(contact.id);
      const statusText = days === null ? 'Never contacted' : days === 0 ? 'Last contact: Today' : days === 1 ? 'Last contact: Yesterday' : `Last contact: ${days} days ago`;
      const interactions = getInteractionsByContact(contact.id);

      app.innerHTML = `
        <div class="view">
          <!-- Header: Back button and Actions with absolutely centered name -->
          <div class="contact-detail-header">
            <button class="back-button" onclick="navigateTo('contacts')">‚Üê Back</button>

            <!-- Absolutely Centered Name Title -->
            <div class="contact-name-center">
              <h1 style="font-size: 1.5rem; font-weight: 700; margin: 0; letter-spacing: -0.025em; color: var(--color-text-primary); line-height: 1.2;">
                ${escapeHtml(getFullName(contact))}${contact.muted ? ' <span style="font-size: 0.75rem; color: var(--color-text-secondary);">üîá</span>' : ''}
              </h1>
              <div style="color: var(--color-text-secondary); font-size: 0.875rem; font-style: italic;">${contact.relationshipType}</div>
            </div>

            <div class="contact-actions">
              <button
                class="btn ${contact.muted ? 'btn-secondary' : 'btn-secondary'}"
                style="padding: 0.5rem 1rem; font-size: 0.875rem; ${contact.muted ? 'background: var(--color-text-secondary); color: white;' : ''}"
                onclick="toggleContactMuted('${contact.id}')"
                title="${contact.muted ? 'Unmute contact' : 'Mute contact (hide from Needs Attention)'}"
              >
                ${contact.muted ? 'üîá Muted' : 'üîî Mute'}
              </button>
              <button
                class="btn ${contact.priority ? 'btn-danger' : 'btn-secondary'}"
                style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                onclick="toggleContactPriority('${contact.id}')"
                title="${contact.priority ? 'Remove from priority' : 'Mark as priority contact'}"
              >
                ${contact.priority ? '‚ö†Ô∏è Contact ASAP' : 'Mark as Priority'}
              </button>
              <button class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="navigateTo('edit-contact', {id: '${contact.id}'})">Edit</button>
            </div>
          </div>

          <!-- Contact Info Card -->
          <div class="card mb-lg" style="border-left: 4px solid var(--color-${status});">
            <!-- Status Badge -->
            <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--color-background); border-radius: var(--border-radius);">
                <span class="status-dot status-${status}"></span>
                <span style="color: var(--color-${status}); font-weight: 600; font-size: 0.8125rem;">${statusText}</span>
              </div>
            </div>

            <!-- Contact Info - horizontal spread -->
            <div class="contact-info-grid">
              ${contact.phone ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">Phone</span>
                  <a href="tel:${contact.phone.replace(/\D/g, '')}" style="color: var(--color-text-primary); text-decoration: none; font-size: 0.8125rem;">${formatPhoneNumber(contact.phone)}</a>
                </div>
              ` : ''}
              ${contact.email ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">Email</span>
                  <a href="mailto:${contact.email}" style="color: var(--color-text-primary); text-decoration: none; font-size: 0.8125rem;">${escapeHtml(contact.email)}</a>
                </div>
              ` : ''}
              ${contact.linkedin ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">LinkedIn</span>
                  <a href="${escapeHtml(contact.linkedin)}" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary); text-decoration: none; font-size: 0.8125rem;">View Profile ‚Üí</a>
                </div>
              ` : ''}
              ${contact.industry ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">Industry</span>
                  <span style="font-size: 0.8125rem;">${escapeHtml(contact.industry)}</span>
                </div>
              ` : ''}
              ${contact.company ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">Company</span>
                  <span style="font-size: 0.8125rem;">${escapeHtml(contact.company)}</span>
                </div>
              ` : ''}
              ${contact.position ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">Position</span>
                  <span style="font-size: 0.8125rem;">${escapeHtml(contact.position)}</span>
                </div>
              ` : ''}
              ${contact.birthdayMonth && contact.birthdayDay ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">Birthday</span>
                  <span style="font-size: 0.8125rem;">${contact.birthdayMonth} ${contact.birthdayDay}</span>
                </div>
              ` : contact.birthday ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">Birthday</span>
                  <span style="font-size: 0.8125rem;">${formatDate(contact.birthday)}</span>
                </div>
              ` : ''}
              ${contact.howWeMet ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">How We Met</span>
                  <span class="text-muted" style="font-size: 0.8125rem;">${escapeHtml(contact.howWeMet)}</span>
                </div>
              ` : ''}
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="min-width: 70px; font-weight: 600; color: var(--color-text-secondary); font-size: 0.8125rem;">Frequency</span>
                <span style="font-size: 0.8125rem;">Every ${getContactFrequency(contact)} days${contact.contactFrequency ? '' : ' (default)'}</span>
              </div>
            </div>
          </div>

          ${contact.notes ? `
            <!-- Notes -->
            <div class="card mb-lg">
              <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--color-text-secondary);">Notes</h3>
              <p style="white-space: pre-wrap; font-size: 0.9375rem; line-height: 1.6; color: var(--color-text-primary);">${escapeHtml(contact.notes)}</p>
            </div>
          ` : ''}

          <!-- Log Interaction Button -->
          <button class="btn btn-block mb-lg" onclick="openInteractionModal('${contact.id}')">
            Log New Interaction
          </button>

          <!-- Interaction History -->
          <div class="card">
            <h2 class="mb-md">Interaction History (${interactions.length})</h2>
            ${interactions.length === 0 ? `
              <div class="empty-state" style="padding: 1rem;">
                <p class="text-muted">No interactions logged yet.</p>
                <p class="text-muted text-small">Click "Log Interaction" above to record your first conversation with this contact.</p>
              </div>
            ` : `
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                ${interactions.map(interaction => {
                  const isFuture = isFutureDate(interaction.date);
                  const borderStyle = isFuture ? 'border-left: 3px solid var(--color-primary); background: linear-gradient(to right, rgba(37, 99, 235, 0.05), transparent);' : '';
                  const typeLabel = isFuture ? `Planned: ${interaction.type}` : interaction.type;
                  // Check if this contact was tagged (vs being the primary contact)
                  const isTagged = interaction.contactId !== contact.id;
                  const primaryContact = isTagged ? getContact(interaction.contactId) : null;
                  // Get all participants for display
                  const allParticipants = [];
                  if (isTagged && primaryContact) {
                    allParticipants.push(getFullName(primaryContact));
                  }
                  if (interaction.taggedContacts && interaction.taggedContacts.length > 0) {
                    interaction.taggedContacts.forEach(taggedId => {
                      if (taggedId !== contact.id) {
                        const taggedContact = getContact(taggedId);
                        if (taggedContact) allParticipants.push(getFullName(taggedContact));
                      }
                    });
                  }
                  return `
                    <div class="card" style="padding: 1rem; margin: 0; position: relative; ${borderStyle}">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                        <div style="font-weight: 600; font-size: 0.9375rem; ${isFuture ? 'color: var(--color-primary);' : ''}">${typeLabel}</div>
                        <div style="display: flex; gap: 0.5rem;">
                          <button
                            onclick="openEditInteractionModal('${interaction.id}')"
                            style="background: none; border: none; color: var(--color-primary); cursor: pointer; padding: 0; font-size: 0.875rem; font-weight: 500;"
                            title="Edit interaction"
                          >Edit</button>
                          <button
                            onclick="duplicateInteraction('${interaction.id}')"
                            style="background: none; border: none; color: var(--color-text-secondary); cursor: pointer; padding: 0; font-size: 0.875rem; font-weight: 500;"
                            title="Duplicate interaction"
                          >Duplicate</button>
                          <button
                            onclick="deleteInteractionWithConfirm('${interaction.id}')"
                            style="background: none; border: none; color: var(--color-danger); cursor: pointer; padding: 0; font-size: 0.875rem; font-weight: 500;"
                            title="Delete interaction"
                          >Delete</button>
                        </div>
                      </div>
                      <div class="text-muted text-small" style="${isFuture ? 'color: var(--color-primary); font-weight: 500;' : ''}">${formatDate(interaction.date)} (${formatRelativeDate(interaction.date)})</div>
                      ${allParticipants.length > 0 ? `<div style="margin-top: 0.375rem; font-size: 0.75rem; color: var(--color-text-secondary);">Also with: ${allParticipants.map(name => escapeHtml(name)).join(', ')}</div>` : ''}
                      ${interaction.notes ? `<div class="text-small" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--color-border);">${escapeHtml(interaction.notes)}</div>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>

          <!-- Delete Contact Button -->
          <div class="mt-md">
            <button class="btn btn-danger btn-block" onclick="deleteContactWithConfirm('${contact.id}')">
              Delete Contact
            </button>
          </div>
        </div>
      `;
    }

    function deleteInteractionWithConfirm(interactionId) {
      if (confirm('Delete this interaction? This cannot be undone.')) {
        deleteInteraction(interactionId);
        showToast('Interaction deleted');
        renderCurrentView();
      }
    }

    function duplicateInteraction(interactionId) {
      const original = AppState.interactions.find(i => i.id === interactionId);
      if (!original) return;

      // Create a copy with today's date
      const duplicate = addInteraction({
        contactId: original.contactId,
        taggedContacts: original.taggedContacts ? [...original.taggedContacts] : [],
        date: getLocalDateString(), // Default to today
        type: original.type,
        notes: original.notes || ''
      });

      showToast('Interaction duplicated');
      renderCurrentView();
    }

    function deleteContactWithConfirm(contactId) {
      const contact = getContact(contactId);
      if (confirm(`Delete ${getFullName(contact)} and all interactions? This cannot be undone.`)) {
        deleteContact(contactId);
        showToast('Contact deleted');
        navigateTo('contacts');
      }
    }

    function handleContactFormCancel() {
      // Navigate back without saving
      if (AppState.currentView === 'edit-contact' && AppState.selectedContactId) {
        navigateTo('contact', { id: AppState.selectedContactId });
      } else {
        navigateTo('contacts');
      }
    }

    function renderContactForm() {
      const app = document.getElementById('app');
      const isEdit = AppState.currentView === 'edit-contact';
      const contact = isEdit ? getContact(AppState.selectedContactId) : null;

      if (isEdit && !contact) {
        app.innerHTML = `
          <div class="view">
            <div class="empty-state">
              <div class="empty-state-icon" style="font-size: 2rem; color: var(--color-danger);">Not Found</div>
              <h2>Contact Not Found</h2>
              <button class="btn mt-md" onclick="navigateTo('contacts')">Back to Contacts</button>
            </div>
          </div>
        `;
        return;
      }

      app.innerHTML = `
        <div class="view">
          <!-- Header -->
          <div style="position: relative; margin-bottom: 1.5rem;">
            <button type="button" class="back-button" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); background: rgba(239, 68, 68, 0.1); color: var(--color-danger); border: 1px solid rgba(239, 68, 68, 0.2);" onclick="handleContactFormCancel()">‚Üê Cancel</button>
            <div class="view-header" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">
              <h1 class="view-title">${isEdit ? 'Edit Contact' : 'Add Contact'}</h1>
            </div>
          </div>

          <!-- Form -->
          <form id="contact-form" onsubmit="handleContactFormSubmit(event)">
            <!-- First Name and Last Name -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div class="form-group">
                <label class="form-label">First Name *</label>
                <input
                  type="text"
                  id="contact-firstname"
                  name="firstName"
                  class="form-input"
                  placeholder="First name"
                  value="${contact ? escapeHtml(contact.firstName || contact.name?.split(' ')[0] || '') : ''}"
                  required
                  autofocus
                />
              </div>
              <div class="form-group">
                <label class="form-label">Last Name</label>
                <input
                  type="text"
                  id="contact-lastname"
                  name="lastName"
                  class="form-input"
                  placeholder="Last name"
                  value="${contact ? escapeHtml(contact.lastName || contact.name?.split(' ').slice(1).join(' ') || '') : ''}"
                />
              </div>
            </div>

            <!-- Relationship Type -->
            <div class="form-group">
              <label class="form-label">Relationship Type *</label>
              <select id="contact-relationship" name="relationshipType" class="form-select" required>
                <option value="">Select type</option>
                <option value="Family" ${contact?.relationshipType === 'Family' ? 'selected' : ''}>Family</option>
                <option value="Close Friend" ${contact?.relationshipType === 'Close Friend' ? 'selected' : ''}>Close Friend</option>
                <option value="Friend" ${contact?.relationshipType === 'Friend' ? 'selected' : ''}>Friend</option>
                <option value="Professional" ${contact?.relationshipType === 'Professional' ? 'selected' : ''}>Professional</option>
                <option value="Acquaintance" ${contact?.relationshipType === 'Acquaintance' ? 'selected' : ''}>Acquaintance</option>
              </select>
            </div>

            <!-- How We Met -->
            <div class="form-group">
              <label class="form-label">How We Met</label>
              <input
                type="text"
                id="contact-howwemet"
                name="howWeMet"
                class="form-input"
                placeholder="e.g., College, Work, Mutual friend"
                value="${contact ? escapeHtml(contact.howWeMet) : ''}"
              />
            </div>

            <!-- Phone -->
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input
                type="tel"
                id="contact-phone"
                name="phone"
                class="form-input"
                placeholder="e.g., (555) 123-4567"
                value="${contact ? escapeHtml(contact.phone) : ''}"
                oninput="this.value = formatPhoneNumber(this.value)"
                maxlength="14"
              />
              <div id="phone-error" class="text-small" style="color: var(--color-danger); margin-top: 0.25rem; display: none;">*please enter a 10-digit phone number without spaces</div>
            </div>

            <!-- Email -->
            <div class="form-group">
              <label class="form-label">Email</label>
              <input
                type="email"
                id="contact-email"
                name="email"
                class="form-input"
                placeholder="email@example.com"
                value="${contact ? escapeHtml(contact.email) : ''}"
              />
              <div id="email-error" class="text-small" style="color: var(--color-danger); margin-top: 0.25rem; display: none;">Please enter a valid email address</div>
            </div>

            <!-- LinkedIn URL and Industry -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div class="form-group">
                <label class="form-label">LinkedIn URL</label>
                <input
                  type="url"
                  id="contact-linkedin"
                  name="linkedin"
                  class="form-input"
                  placeholder="https://linkedin.com/in/username"
                  value="${contact ? escapeHtml(contact.linkedin || '') : ''}"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Industry</label>
                <input
                  type="text"
                  id="contact-industry"
                  name="industry"
                  class="form-input"
                  placeholder="e.g., Technology, Finance"
                  value="${contact ? escapeHtml(contact.industry || '') : ''}"
                />
              </div>
            </div>

            <!-- Company and Position -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div class="form-group">
                <label class="form-label">Company</label>
                <input
                  type="text"
                  id="contact-company"
                  name="company"
                  class="form-input"
                  placeholder="e.g., Google, Microsoft"
                  value="${contact ? escapeHtml(contact.company || '') : ''}"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Position</label>
                <input
                  type="text"
                  id="contact-position"
                  name="position"
                  class="form-input"
                  placeholder="e.g., Software Engineer"
                  value="${contact ? escapeHtml(contact.position || '') : ''}"
                />
              </div>
            </div>

            <!-- Birthday -->
            <div class="form-group">
              <label class="form-label">Birthday</label>
              <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem;">
                <select id="contact-birthday-month" name="birthdayMonth" class="form-select">
                  <option value="">Month</option>
                  <option value="January" ${contact?.birthdayMonth === 'January' ? 'selected' : ''}>January</option>
                  <option value="February" ${contact?.birthdayMonth === 'February' ? 'selected' : ''}>February</option>
                  <option value="March" ${contact?.birthdayMonth === 'March' ? 'selected' : ''}>March</option>
                  <option value="April" ${contact?.birthdayMonth === 'April' ? 'selected' : ''}>April</option>
                  <option value="May" ${contact?.birthdayMonth === 'May' ? 'selected' : ''}>May</option>
                  <option value="June" ${contact?.birthdayMonth === 'June' ? 'selected' : ''}>June</option>
                  <option value="July" ${contact?.birthdayMonth === 'July' ? 'selected' : ''}>July</option>
                  <option value="August" ${contact?.birthdayMonth === 'August' ? 'selected' : ''}>August</option>
                  <option value="September" ${contact?.birthdayMonth === 'September' ? 'selected' : ''}>September</option>
                  <option value="October" ${contact?.birthdayMonth === 'October' ? 'selected' : ''}>October</option>
                  <option value="November" ${contact?.birthdayMonth === 'November' ? 'selected' : ''}>November</option>
                  <option value="December" ${contact?.birthdayMonth === 'December' ? 'selected' : ''}>December</option>
                </select>
                <input
                  type="number"
                  id="contact-birthday-day"
                  name="birthdayDay"
                  class="form-input"
                  placeholder="Day"
                  min="1"
                  max="31"
                  value="${contact?.birthdayDay || ''}"
                />
              </div>
            </div>

            <!-- Contact Frequency -->
            <div class="form-group">
              <label class="form-label">Contact Frequency</label>
              <select
                id="contact-frequency-select"
                class="form-select"
                onchange="handleFrequencySelectChange(this.value)"
              >
                <option value="" ${!contact?.contactFrequency ? 'selected' : ''}>Use Default (${contact ? getDefaultContactFrequency(contact.relationshipType) + ' days' : 'based on type'})</option>
                <option value="14" ${contact?.contactFrequency === 14 ? 'selected' : ''}>Bi-weekly (14 days)</option>
                <option value="30" ${contact?.contactFrequency === 30 ? 'selected' : ''}>Monthly (30 days)</option>
                <option value="60" ${contact?.contactFrequency === 60 ? 'selected' : ''}>Bi-monthly (60 days)</option>
                <option value="90" ${contact?.contactFrequency === 90 ? 'selected' : ''}>Quarterly (90 days)</option>
                <option value="custom" ${contact?.contactFrequency && ![14, 30, 60, 90].includes(contact.contactFrequency) ? 'selected' : ''}>Custom</option>
              </select>
              <div id="custom-frequency-container" style="margin-top: 0.5rem; display: ${contact?.contactFrequency && ![14, 30, 60, 90].includes(contact.contactFrequency) ? 'block' : 'none'};">
                <input
                  type="number"
                  id="contact-frequency-custom"
                  class="form-input"
                  placeholder="Enter days"
                  min="1"
                  max="365"
                  value="${contact?.contactFrequency && ![14, 30, 60, 90].includes(contact.contactFrequency) ? contact.contactFrequency : ''}"
                />
              </div>
              <input type="hidden" id="contact-frequency" name="contactFrequency" value="${contact?.contactFrequency || ''}" />
            </div>

            <!-- Notes -->
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea
                id="contact-notes"
                name="notes"
                class="form-input"
                placeholder="Any additional notes about this contact..."
                rows="4"
                style="resize: vertical; min-height: 100px;"
              >${contact?.notes || ''}</textarea>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-block" style="margin-top: 1.5rem; margin-bottom: 2rem;">
              ${isEdit ? 'Save Changes' : 'Add Contact'}
            </button>
          </form>
        </div>
      `;

      // Set up real-time validation
      setTimeout(() => {
        const phoneInput = document.getElementById('contact-phone');
        const emailInput = document.getElementById('contact-email');
        const phoneError = document.getElementById('phone-error');
        const emailError = document.getElementById('email-error');

        if (phoneInput) {
          // Format existing phone number on load
          if (phoneInput.value) {
            phoneInput.value = formatPhoneNumber(phoneInput.value);
          }
          
          phoneInput.addEventListener('blur', () => {
            const digits = phoneInput.value.replace(/\D/g, '');
            if (phoneInput.value && digits.length !== 10) {
              phoneError.style.display = 'block';
            } else {
              phoneError.style.display = 'none';
            }
          });
          phoneInput.addEventListener('input', () => {
            const digits = phoneInput.value.replace(/\D/g, '');
            if (digits.length === 10) {
              phoneError.style.display = 'none';
            }
          });
        }

        if (emailInput) {
          emailInput.addEventListener('blur', () => {
            if (emailInput.value && !validateEmail(emailInput.value)) {
              emailError.style.display = 'block';
            } else {
              emailError.style.display = 'none';
            }
          });
        }
      }, 0);
    }

    function handleFrequencySelectChange(value) {
      const customContainer = document.getElementById('custom-frequency-container');
      const hiddenInput = document.getElementById('contact-frequency');
      const customInput = document.getElementById('contact-frequency-custom');

      if (value === 'custom') {
        customContainer.style.display = 'block';
        hiddenInput.value = customInput.value || '';
        // Add listener to update hidden input when custom value changes
        customInput.oninput = () => {
          hiddenInput.value = customInput.value;
        };
      } else {
        customContainer.style.display = 'none';
        hiddenInput.value = value; // Will be empty string for "Use Default" or a number
      }
    }

    function handleContactFormSubmit(event) {
      event.preventDefault();
      console.log('üìù Form submitted');

      try {
        const formData = new FormData(event.target);
        const contactFrequencyValue = formData.get('contactFrequency');
        const data = {
          firstName: formData.get('firstName').trim(),
          lastName: formData.get('lastName').trim(),
          relationshipType: formData.get('relationshipType'),
          howWeMet: formData.get('howWeMet').trim(),
          phone: formData.get('phone').trim(),
          email: formData.get('email').trim(),
          linkedin: formData.get('linkedin').trim(),
          industry: formData.get('industry').trim(),
          birthdayMonth: formData.get('birthdayMonth'),
          birthdayDay: formData.get('birthdayDay'),
          contactFrequency: contactFrequencyValue ? parseInt(contactFrequencyValue) : null
        };
        
        console.log('üìù Form data:', data);

        // Validate
        if (!data.firstName) {
          showToast('First name is required', 'error');
          return;
        }

        if (!data.relationshipType) {
          showToast('Relationship type is required', 'error');
          return;
        }

        if (data.email && !validateEmail(data.email)) {
          showToast('Invalid email address', 'error');
          return;
        }

        if (data.phone && !validatePhone(data.phone)) {
          showToast('Invalid phone number', 'error');
          return;
        }

        // Validate birthday day (max 31)
        if (data.birthdayDay && (parseInt(data.birthdayDay) < 1 || parseInt(data.birthdayDay) > 31)) {
          showToast('Birthday day must be between 1 and 31', 'error');
          return;
        }

        // Validate birthday - if one is provided, both must be
        if ((data.birthdayMonth && !data.birthdayDay) || (!data.birthdayMonth && data.birthdayDay)) {
          showToast('Please enter both month and day for birthday', 'error');
          return;
        }

        console.log('‚úÖ Validation passed');

        // Save
        const isEdit = AppState.currentView === 'edit-contact';
        if (isEdit) {
          console.log('‚úèÔ∏è Updating contact:', AppState.selectedContactId);
          updateContact(AppState.selectedContactId, data);
          showToast('Contact updated');
          navigateTo('contact', { id: AppState.selectedContactId });
        } else {
          console.log('‚ûï Adding new contact');
          const newContact = addContact(data);
          console.log('‚úÖ Contact added with ID:', newContact.id);
          console.log('üìä Total contacts now:', AppState.contacts.length);
          showToast('Contact added');
          navigateTo('contact', { id: newContact.id });
        }
      } catch (error) {
        console.error('‚ùå Error in handleContactFormSubmit:', error);
        showToast('Error saving contact: ' + error.message, 'error');
      }
    }

    /* ===== INTERACTION MODAL ===== */

    let interactionModalState = {
      contactId: null,
      selectedType: null,
      selectedDate: getLocalDateString(),
      taggedContacts: []
    };

    function openInteractionModal(contactId) {
      const contact = getContact(contactId);
      if (!contact) return;

      interactionModalState = {
        contactId: contactId,
        selectedType: null,
        selectedDate: getLocalDateString(),
        taggedContacts: []
      };

      const modal = document.getElementById('interaction-modal');
      const modalContent = document.getElementById('modal-content');

      const interactionTypes = [
        { type: 'Call', icon: '‚òéÔ∏è' },
        { type: 'Text', icon: 'üì±' },
        { type: 'Email', icon: '‚úâÔ∏è' },
        { type: 'In-Person', icon: 'ü§ù' },
        { type: 'Video', icon: 'üñ•Ô∏è' },
        { type: 'LinkedIn', icon: 'ü§µ' }
      ];

      // Get other contacts for tagging (exclude current contact)
      const otherContacts = AppState.contacts
        .filter(c => c.id !== contactId)
        .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));

      modalContent.innerHTML = `
        <p class="text-muted mb-md">with ${escapeHtml(getFullName(contact))}</p>

        <!-- Date Selection -->
        <div class="form-group">
          <label class="form-label">Date *</label>
          <div class="quick-dates">
            <button type="button" class="quick-date-btn selected" onclick="selectQuickDate('today')">Today</button>
            <button type="button" class="quick-date-btn" onclick="selectQuickDate('yesterday')">Yesterday</button>
            <button type="button" class="quick-date-btn" onclick="selectQuickDate('2days')">2 days ago</button>
          </div>
          <input
            type="date"
            id="interaction-date"
            class="form-input"
            value="${interactionModalState.selectedDate}"
            onchange="interactionModalState.selectedDate = this.value; updateQuickDateButtons();"
          />
          <div class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">Today is ${new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
        </div>

        <!-- Interaction Type -->
        <div class="form-group">
          <label class="form-label">Type *</label>
          <div class="interaction-types">
            ${interactionTypes.map(({ type, icon }) => `
              <button
                type="button"
                class="interaction-type-btn"
                onclick="selectInteractionType('${type}')"
                data-type="${type}"
              >
                <span class="icon">${icon}</span>
                <span class="label">${type}</span>
              </button>
            `).join('')}
          </div>
        </div>

        <!-- Tag Other Contacts -->
        ${otherContacts.length > 0 ? `
          <div class="form-group">
            <label class="form-label">Tag other contacts (optional)</label>
            <div id="tagged-contacts-display" style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 0.5rem; min-height: 0;"></div>
            <select
              id="tag-contact-select"
              class="form-select"
              onchange="addTaggedContact(this.value); this.value = '';"
            >
              <option value="">+ Add another person...</option>
              ${otherContacts.map(c => `
                <option value="${c.id}">${escapeHtml(getFullName(c))}</option>
              `).join('')}
            </select>
          </div>
        ` : ''}

        <!-- Notes -->
        <div class="form-group">
          <label class="form-label">Notes (optional)</label>
          <textarea
            id="interaction-notes"
            class="form-textarea"
            placeholder="Add any notes about this interaction..."
            rows="3"
          ></textarea>
        </div>

        <!-- Submit -->
        <button class="btn btn-block" onclick="handleInteractionSubmit()">Log Interaction</button>
      `;

      modal.classList.add('active');
    }

    function openEditInteractionModal(interactionId) {
      const interaction = AppState.interactions.find(i => i.id === interactionId);
      if (!interaction) return;

      const contact = getContact(interaction.contactId);
      if (!contact) return;

      interactionModalState = {
        contactId: interaction.contactId,
        selectedType: interaction.type,
        selectedDate: interaction.date,
        editingId: interactionId,
        taggedContacts: interaction.taggedContacts ? [...interaction.taggedContacts] : []
      };

      const modal = document.getElementById('interaction-modal');
      const modalContent = document.getElementById('modal-content');
      const modalTitle = document.querySelector('.modal-title');
      modalTitle.textContent = 'Edit Interaction';

      const interactionTypes = [
        { type: 'Call', icon: '‚òéÔ∏è' },
        { type: 'Text', icon: 'üì±' },
        { type: 'Email', icon: '‚úâÔ∏è' },
        { type: 'In-Person', icon: 'ü§ù' },
        { type: 'Video', icon: 'üñ•Ô∏è' },
        { type: 'LinkedIn', icon: 'ü§µ' }
      ];

      // Get other contacts for tagging (exclude current contact)
      const otherContacts = AppState.contacts
        .filter(c => c.id !== interaction.contactId)
        .sort((a, b) => getFullName(a).localeCompare(getFullName(b)));

      modalContent.innerHTML = `
        <p class="text-muted mb-md">with ${escapeHtml(getFullName(contact))}</p>

        <!-- Date Selection -->
        <div class="form-group">
          <label class="form-label">Date *</label>
          <input
            type="date"
            id="interaction-date"
            class="form-input"
            value="${interaction.date}"
            onchange="interactionModalState.selectedDate = this.value;"
          />
          <div class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">Today is ${new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
        </div>

        <!-- Interaction Type -->
        <div class="form-group">
          <label class="form-label">Type *</label>
          <div class="interaction-types">
            ${interactionTypes.map(({ type, icon }) => `
              <button
                type="button"
                class="interaction-type-btn ${type === interaction.type ? 'selected' : ''}"
                onclick="selectInteractionType('${type}')"
                data-type="${type}"
              >
                <span class="icon">${icon}</span>
                <span class="label">${type}</span>
              </button>
            `).join('')}
          </div>
        </div>

        <!-- Tag Other Contacts -->
        ${otherContacts.length > 0 ? `
          <div class="form-group">
            <label class="form-label">Tag other contacts (optional)</label>
            <div id="tagged-contacts-display" style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 0.5rem; min-height: 0;"></div>
            <select
              id="tag-contact-select"
              class="form-select"
              onchange="addTaggedContact(this.value); this.value = '';"
            >
              <option value="">+ Add another person...</option>
              ${otherContacts.map(c => `
                <option value="${c.id}" ${interactionModalState.taggedContacts.includes(c.id) ? 'style="display: none;"' : ''}>${escapeHtml(getFullName(c))}</option>
              `).join('')}
            </select>
          </div>
        ` : ''}

        <!-- Notes -->
        <div class="form-group">
          <label class="form-label">Notes (optional)</label>
          <textarea
            id="interaction-notes"
            class="form-textarea"
            placeholder="Add any notes about this interaction..."
            rows="3"
          >${escapeHtml(interaction.notes || '')}</textarea>
        </div>

        <!-- Submit -->
        <button class="btn btn-block" onclick="handleInteractionSubmit()">Save Changes</button>
      `;

      // Display existing tagged contacts
      updateTaggedContactsDisplay();

      modal.classList.add('active');
    }

    function closeInteractionModal() {
      const modal = document.getElementById('interaction-modal');
      modal.classList.remove('active');

      // Reset modal title
      const modalTitle = document.querySelector('.modal-title');
      modalTitle.textContent = 'Log Interaction';

      interactionModalState = { contactId: null, selectedType: null, selectedDate: getLocalDateString(), taggedContacts: [] };
    }

    function selectQuickDate(option) {
      let dateStr;

      if (option === 'today') {
        dateStr = getLocalDateString();
      } else if (option === 'yesterday') {
        dateStr = getYesterdayString();
      } else if (option === '2days') {
        dateStr = getTwoDaysAgoString();
      }

      interactionModalState.selectedDate = dateStr;
      document.getElementById('interaction-date').value = interactionModalState.selectedDate;
      updateQuickDateButtons();
    }

    function updateQuickDateButtons() {
      const today = getLocalDateString();
      const yesterday = getYesterdayString();
      const twoDaysAgo = getTwoDaysAgoString();
      const selected = interactionModalState.selectedDate;

      document.querySelectorAll('.quick-date-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      if (selected === today) {
        document.querySelectorAll('.quick-date-btn')[0]?.classList.add('selected');
      } else if (selected === yesterday) {
        document.querySelectorAll('.quick-date-btn')[1]?.classList.add('selected');
      } else if (selected === twoDaysAgo) {
        document.querySelectorAll('.quick-date-btn')[2]?.classList.add('selected');
      }
    }

    function selectInteractionType(type) {
      interactionModalState.selectedType = type;

      document.querySelectorAll('.interaction-type-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      document.querySelector(`.interaction-type-btn[data-type="${type}"]`)?.classList.add('selected');
    }

    function addTaggedContact(contactId) {
      if (!contactId || interactionModalState.taggedContacts.includes(contactId)) return;
      interactionModalState.taggedContacts.push(contactId);
      updateTaggedContactsDisplay();
      // Hide selected contact from dropdown
      const option = document.querySelector(`#tag-contact-select option[value="${contactId}"]`);
      if (option) option.style.display = 'none';
    }

    function removeTaggedContact(contactId) {
      interactionModalState.taggedContacts = interactionModalState.taggedContacts.filter(id => id !== contactId);
      updateTaggedContactsDisplay();
      // Show contact in dropdown again
      const option = document.querySelector(`#tag-contact-select option[value="${contactId}"]`);
      if (option) option.style.display = '';
    }

    function updateTaggedContactsDisplay() {
      const container = document.getElementById('tagged-contacts-display');
      if (!container) return;

      container.innerHTML = interactionModalState.taggedContacts.map(contactId => {
        const contact = getContact(contactId);
        if (!contact) return '';
        return `
          <span style="display: inline-flex; align-items: center; gap: 0.25rem; background: var(--color-primary); color: white; padding: 0.25rem 0.5rem; border-radius: 1rem; font-size: 0.75rem;">
            ${escapeHtml(getFullName(contact))}
            <button
              type="button"
              onclick="removeTaggedContact('${contactId}')"
              style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin-left: 0.125rem; font-size: 0.875rem; line-height: 1;"
            >&times;</button>
          </span>
        `;
      }).join('');
    }

    function handleInteractionSubmit() {
      if (!interactionModalState.selectedType) {
        showToast('Please select an interaction type', 'error');
        return;
      }

      // Read date directly from input to ensure we get the user's selected value
      const dateInput = document.getElementById('interaction-date');
      const selectedDate = dateInput ? dateInput.value : interactionModalState.selectedDate;
      const notes = document.getElementById('interaction-notes')?.value || '';

      if (interactionModalState.editingId) {
        // Edit existing interaction
        updateInteraction(interactionModalState.editingId, {
          date: selectedDate,
          type: interactionModalState.selectedType,
          notes: notes,
          taggedContacts: interactionModalState.taggedContacts || []
        });
        showToast('Interaction updated');
      } else {
        // Add new interaction
        addInteraction({
          contactId: interactionModalState.contactId,
          taggedContacts: interactionModalState.taggedContacts || [],
          date: selectedDate,
          type: interactionModalState.selectedType,
          notes: notes
        });
        const tagCount = interactionModalState.taggedContacts?.length || 0;
        showToast(tagCount > 0 ? `Interaction logged with ${tagCount + 1} people` : 'Interaction logged');
      }

      closeInteractionModal();
      renderCurrentView();
    }

    /* ===== DATA EXPORT/IMPORT ===== */

    function exportData() {
      try {
        const data = {
          version: '1.0',
          exportedAt: new Date().toISOString(),
          contacts: AppState.contacts,
          interactions: AppState.interactions,
          totalContacts: AppState.contacts.length,
          totalInteractions: AppState.interactions.length
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `relationship-crm-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Data exported successfully');
      } catch (error) {
        console.error('Export error:', error);
        showToast('Error exporting data', 'error');
      }
    }

    function exportCSV() {
      try {
        if (AppState.contacts.length === 0) {
          showToast('No contacts to export', 'error');
          return;
        }

        // CSV headers
        const headers = ['Name', 'Relationship Type', 'Phone', 'Email', 'LinkedIn', 'Industry', 'Birthday Month', 'Birthday Day', 'How We Met', 'Last Contacted'];

        // Convert contacts to CSV rows
        const rows = AppState.contacts.map(contact => {
          const lastContactDate = contact.lastContactedAt ? new Date(contact.lastContactedAt).toLocaleDateString() : 'Never';
          return [
            getFullName(contact),
            contact.relationshipType,
            contact.phone || '',
            contact.email || '',
            contact.linkedin || '',
            contact.industry || '',
            contact.birthdayMonth || '',
            contact.birthdayDay || '',
            contact.howWeMet || '',
            lastContactDate
          ];
        });

        // Combine headers and rows
        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
        ].join('\n');

        // Create and download the file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `relationship-crm-contacts-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Contacts exported to CSV');
      } catch (error) {
        console.error('CSV export error:', error);
        showToast('Error exporting CSV', 'error');
      }
    }

    function downloadCSVTemplate() {
      const headers = ['First Name', 'Last Name', 'Relationship Type', 'Phone', 'Email', 'LinkedIn', 'Industry', 'Birthday Month', 'Birthday Day', 'How We Met'];
      const exampleRow = ['John', 'Doe', 'Professional', '(555) 123-4567', 'john@example.com', 'https://linkedin.com/in/johndoe', 'Technology', 'January', '15', 'Work conference'];

      const csvContent = [
        headers.join(','),
        exampleRow.map(cell => `"${cell}"`).join(',')
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'contact-import-template.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Template downloaded');
    }

    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const lines = text.split(/\r?\n/).filter(line => line.trim());

          if (lines.length < 2) {
            showToast('CSV file is empty or has no data rows', 'error');
            return;
          }

          // Parse headers (first row)
          const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());

          // Map headers to our field names
          const headerMap = {
            'first name': 'firstName',
            'firstname': 'firstName',
            'last name': 'lastName',
            'lastname': 'lastName',
            'name': 'name',
            'relationship type': 'relationshipType',
            'relationshiptype': 'relationshipType',
            'type': 'relationshipType',
            'phone': 'phone',
            'email': 'email',
            'linkedin': 'linkedin',
            'linkedin url': 'linkedin',
            'industry': 'industry',
            'birthday month': 'birthdayMonth',
            'birthdaymonth': 'birthdayMonth',
            'birthday day': 'birthdayDay',
            'birthdayday': 'birthdayDay',
            'how we met': 'howWeMet',
            'howwemet': 'howWeMet',
            'met': 'howWeMet'
          };

          // Find column indices
          const columnMap = {};
          headers.forEach((header, index) => {
            const fieldName = headerMap[header];
            if (fieldName) {
              columnMap[fieldName] = index;
            }
          });

          // Check for required field (at least name or first name)
          if (columnMap.firstName === undefined && columnMap.name === undefined) {
            showToast('CSV must have "First Name" or "Name" column', 'error');
            return;
          }

          // Parse data rows
          const contacts = [];
          for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            if (values.length === 0 || values.every(v => !v.trim())) continue;

            const contact = {
              firstName: values[columnMap.firstName] || '',
              lastName: values[columnMap.lastName] || '',
              relationshipType: values[columnMap.relationshipType] || 'Acquaintance',
              phone: values[columnMap.phone] || '',
              email: values[columnMap.email] || '',
              linkedin: values[columnMap.linkedin] || '',
              industry: values[columnMap.industry] || '',
              birthdayMonth: values[columnMap.birthdayMonth] || '',
              birthdayDay: values[columnMap.birthdayDay] || '',
              howWeMet: values[columnMap.howWeMet] || ''
            };

            // Handle "Name" column (split into first/last)
            if (columnMap.name !== undefined && !contact.firstName) {
              const fullName = values[columnMap.name] || '';
              const nameParts = fullName.trim().split(/\s+/);
              contact.firstName = nameParts[0] || '';
              contact.lastName = nameParts.slice(1).join(' ') || '';
            }

            // Skip if no name
            if (!contact.firstName.trim()) continue;

            // Validate relationship type
            const validTypes = ['Family', 'Close Friend', 'Friend', 'Professional', 'Acquaintance'];
            if (!validTypes.includes(contact.relationshipType)) {
              contact.relationshipType = 'Acquaintance';
            }

            // Format phone number if present
            if (contact.phone) {
              contact.phone = formatPhoneNumber(contact.phone);
            }

            contacts.push(contact);
          }

          if (contacts.length === 0) {
            showToast('No valid contacts found in CSV', 'error');
            return;
          }

          // Confirm import
          if (!confirm(`Import ${contacts.length} contacts? They will be added to your existing contacts.`)) {
            return;
          }

          // Add contacts
          let added = 0;
          contacts.forEach(contactData => {
            addContact(contactData);
            added++;
          });

          showToast(`Imported ${added} contacts`);
          renderCurrentView();

        } catch (error) {
          console.error('CSV import error:', error);
          showToast('Error importing CSV: ' + error.message, 'error');
        }
      };

      reader.onerror = () => {
        showToast('Error reading file', 'error');
      };

      reader.readAsText(file);
      event.target.value = ''; // Reset file input
    }

    // Helper function to parse CSV line (handles quoted values)
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (inQuotes) {
          if (char === '"' && nextChar === '"') {
            current += '"';
            i++; // Skip next quote
          } else if (char === '"') {
            inQuotes = false;
          } else {
            current += char;
          }
        } else {
          if (char === '"') {
            inQuotes = true;
          } else if (char === ',') {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
      }

      result.push(current.trim());
      return result;
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);

          // Validate structure
          if (!data.contacts || !data.interactions || !Array.isArray(data.contacts) || !Array.isArray(data.interactions)) {
            throw new Error('Invalid backup file format');
          }

          // Ask user if they want to merge or replace
          const merge = confirm(
            `Import ${data.contacts.length} contacts and ${data.interactions.length} interactions?\n\n` +
            `Click OK to REPLACE your current data.\n` +
            `Click Cancel to MERGE with existing data.`
          );

          if (merge === false) {
            // Merge: combine with existing data
            // Create a map of existing contact IDs to avoid duplicates by name
            const existingNames = new Set(AppState.contacts.map(c => getFullName(c).toLowerCase()));
            const newContacts = data.contacts.filter(c => {
              const fullName = c.firstName && c.lastName ? `${c.firstName} ${c.lastName}`.trim().toLowerCase() : (c.name || '').toLowerCase();
              return !existingNames.has(fullName);
            });

            AppState.contacts = [...AppState.contacts, ...newContacts];
            AppState.interactions = [...AppState.interactions, ...data.interactions];

            showToast(`Imported ${newContacts.length} new contacts and ${data.interactions.length} interactions`);
          } else {
            // Replace: overwrite existing data
            AppState.contacts = data.contacts;
            AppState.interactions = data.interactions;

            showToast(`Imported ${data.contacts.length} contacts and ${data.interactions.length} interactions`);
          }

          saveState();
          renderCurrentView();

          // Clear the file input
          event.target.value = '';
        } catch (error) {
          console.error('Import error:', error);
          showToast('Error importing data: ' + error.message, 'error');
          event.target.value = '';
        }
      };

      reader.onerror = () => {
        showToast('Error reading file', 'error');
        event.target.value = '';
      };

      reader.readAsText(file);
    }

    function clearAllData() {
      const contactCount = AppState.contacts.length;
      const interactionCount = AppState.interactions.length;

      if (contactCount === 0) {
        showToast('No data to clear', 'error');
        return;
      }

      const confirmed = confirm(
        `‚ö†Ô∏è WARNING: Delete ALL data?\n\n` +
        `This will permanently delete:\n` +
        `‚Ä¢ ${contactCount} contacts\n` +
        `‚Ä¢ ${interactionCount} interactions\n\n` +
        `This cannot be undone. Export a backup first if needed.\n\n` +
        `Type "DELETE" to confirm.`
      );

      if (!confirmed) return;

      const doubleConfirm = prompt('Type DELETE to confirm:');
      if (doubleConfirm !== 'DELETE') {
        showToast('Deletion cancelled', 'error');
        return;
      }

      // Clear all data
      AppState.contacts = [];
      AppState.interactions = [];
      localStorage.clear();
      saveState();

      showToast('All data cleared');
      navigateTo('dashboard');
    }

    /* ===== SETTINGS VIEW ===== */

    function renderEnrichmentConflicts() {
      const app = document.getElementById('app');

      if (AppState.enrichmentConflicts.length === 0) {
        app.innerHTML = `
          <div class="view">
            <div class="page-header">
              <div class="content-container" style="display: flex; align-items: center; gap: 1rem;">
                <button class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="navigateTo('contacts')">
                  ‚Üê Back
                </button>
                <h1 class="view-title" style="margin: 0; flex: 1;">Data Conflicts</h1>
              </div>
            </div>
            <div class="content-container">
              <div class="empty-state">
                <div class="empty-state-icon" style="font-size: 2rem; color: var(--color-success);">‚úì</div>
                <h2>No Conflicts</h2>
                <p class="text-muted">All your contact data is in sync!</p>
                <button class="btn mt-md" onclick="navigateTo('contacts')">Back to Contacts</button>
              </div>
            </div>
          </div>
        `;
        return;
      }

      app.innerHTML = `
        <div class="view">
          <div class="page-header">
            <div class="content-container" style="display: flex; align-items: center; gap: 1rem;">
              <button class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="navigateTo('contacts')">
                ‚Üê Back
              </button>
              <h1 class="view-title" style="margin: 0; flex: 1;">Resolve Conflicts</h1>
            </div>
          </div>

          <div class="content-container">
          <div style="padding: var(--spacing-md); background: #FEF3C7; border: 1px solid #FCD34D; border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
            <div style="font-weight: 600; color: #92400E; margin-bottom: 0.25rem;">
              ${AppState.enrichmentConflicts.length} contact(s) with conflicts
            </div>
            <div style="font-size: 0.875rem; color: #78350F;">
              For each field, choose whether to keep your current value or use the LinkedIn data.
            </div>
          </div>

          ${AppState.enrichmentConflicts.map(conflictData => {
            const contact = AppState.contacts.find(c => c.id === conflictData.contactId);
            if (!contact) return '';

            return `
              <div class="card mb-md">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: var(--spacing-md); color: var(--color-text-primary);">
                  ${escapeHtml(getFullName(contact))}
                </h3>

                ${conflictData.conflicts.map(conflict => `
                  <div style="padding: var(--spacing-md); background: var(--color-background); border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
                    <div style="font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--color-text-primary);">
                      ${conflict.label}
                    </div>
                    
                    <div style="display: grid; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-sm); background: var(--color-surface); border-radius: var(--border-radius); border: 2px solid var(--color-border);">
                        <div style="flex: 1;">
                          <div style="font-size: 0.75rem; color: var(--color-text-secondary); margin-bottom: 0.125rem;">YOUR CURRENT VALUE</div>
                          <div style="font-weight: 500;">${escapeHtml(conflict.current)}</div>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="resolveConflict('${conflictData.contactId}', '${conflict.field}', false)">
                          Keep This
                        </button>
                      </div>
                      
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-sm); background: var(--color-surface); border-radius: var(--border-radius); border: 2px solid #DBEAFE;">
                        <div style="flex: 1;">
                          <div style="font-size: 0.75rem; color: #1E40AF; margin-bottom: 0.125rem;">LINKEDIN DATA</div>
                          <div style="font-weight: 500;">${escapeHtml(conflict.new)}</div>
                        </div>
                        <button class="btn btn-small" onclick="resolveConflict('${conflictData.contactId}', '${conflict.field}', true)">
                          Use This
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            `;
          }).join('')}
          </div>
        </div>
      `;
    }

    function renderSettings() {
      const app = document.getElementById('app');

      app.innerHTML = `
        <div class="view">
          <div class="page-header">
            <div class="content-container">
              <div class="view-header">
                <h1 class="view-title">Settings</h1>
              </div>
            </div>
          </div>

          <div class="content-container">
          <!-- Data Management -->
          <div class="card mb-lg">
            <h2 class="mb-md" style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: #F3F4F6; color: #374151; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">DATA</span>
              <span>Data Management</span>
            </h2>

            <!-- Export Section -->
            <div style="margin-bottom: 1rem;">
              <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 0.5rem;">Export</h3>
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="btn btn-secondary btn-block" onclick="exportData()">
                  Export JSON (Full Backup)
                </button>
                <button class="btn btn-secondary btn-block" onclick="exportCSV()">
                  Export CSV (Contacts Only)
                </button>
              </div>
            </div>

            <!-- Import Section -->
            <div style="margin-bottom: 1rem;">
              <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 0.5rem;">Import</h3>
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="btn btn-secondary btn-block" onclick="document.getElementById('import-file').click()">
                  Import JSON (Restore Backup)
                </button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn btn-secondary btn-block" onclick="document.getElementById('import-csv-file').click()">
                  Import CSV (Contacts)
                </button>
                <input type="file" id="import-csv-file" accept=".csv,.xlsx,.xls" style="display: none;" onchange="importCSV(event)">
              </div>
            </div>

            <p class="text-muted text-small">
              <strong>JSON:</strong> Full backup including contacts and interactions.<br>
              <strong>CSV:</strong> Import contacts from spreadsheet. <a href="#" onclick="downloadCSVTemplate(); return false;" style="color: var(--color-primary);">Download the template</a> to see required headers.
            </p>
          </div>

          <!-- LinkedIn Enrichment -->
          <div class="card mb-lg">
            <h2 class="mb-md" style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: #DBEAFE; color: #1E40AF; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">üíº LINKEDIN</span>
              <span>LinkedIn Enrichment</span>
            </h2>
            
            ${AppState.linkedinData.length > 0 ? `
              <div style="padding: var(--spacing-md); background: #ECFDF5; border: 1px solid #A7F3D0; border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
                <div style="display: flex; align-items: center; gap: 0.5rem; color: #065F46; font-weight: 600; margin-bottom: 0.25rem;">
                  <span>‚úì</span> LinkedIn database loaded
                </div>
                <div style="font-size: 0.875rem; color: #047857;">
                  ${AppState.linkedinData.length} profiles available for enrichment
                </div>
              </div>
              
              <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: var(--spacing-md);">
                <button class="btn btn-block" onclick="enrichAllContacts()">
                  Enrich All Contacts
                </button>
                <button class="btn btn-secondary btn-block" onclick="document.getElementById('linkedin-file-input').click()">
                  Re-upload LinkedIn CSV
                </button>
                <button class="btn btn-secondary btn-block" onclick="clearLinkedInData()" style="color: var(--color-danger);">
                  Clear LinkedIn Data
                </button>
              </div>
            ` : `
              <p class="text-muted text-small mb-md">
                Upload your LinkedIn connections CSV to create a reference database. When you add contacts with LinkedIn URLs, their company and position will be automatically filled in.
              </p>
              
              <div style="margin-bottom: var(--spacing-md);">
                <button class="btn btn-block" onclick="document.getElementById('linkedin-file-input').click()">
                  üìä Upload LinkedIn CSV
                </button>
              </div>
              
              <details style="padding: var(--spacing-md); background: var(--color-background); border-radius: var(--border-radius);">
                <summary style="cursor: pointer; font-weight: 600; color: var(--color-primary); margin-bottom: var(--spacing-sm);">
                  How to download your LinkedIn connections
                </summary>
                <ol style="margin-top: var(--spacing-sm); padding-left: 1.5rem; color: var(--color-text-secondary); font-size: 0.875rem; line-height: 1.6;">
                  <li>Go to <strong>LinkedIn.com</strong> ‚Üí <strong>Me</strong> ‚Üí <strong>Settings & Privacy</strong></li>
                  <li>Navigate to <strong>Data Privacy</strong> ‚Üí <strong>Get a copy of your data</strong></li>
                  <li>Select <strong>"Want something in particular?"</strong></li>
                  <li>Check the box for <strong>Connections</strong></li>
                  <li>Click <strong>Request archive</strong></li>
                  <li>LinkedIn will email you a download link (usually within 10 minutes)</li>
                  <li>Download and extract the ZIP file</li>
                  <li>Upload the <strong>Connections.csv</strong> file here</li>
                </ol>
              </details>
            `}
            
            <input type="file" id="linkedin-file-input" accept=".csv" style="display: none;" onchange="handleLinkedInCSVUpload(event)">
          </div>

          <!-- Danger Zone -->
          <div class="card" style="border: 1px solid var(--color-danger); border-left: 3px solid var(--color-danger);">
            <h2 class="mb-md" style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%); color: #991B1B; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">DANGER</span>
              <span>Danger Zone</span>
            </h2>
            <p class="text-muted text-small mb-md">
              This action cannot be undone. Make sure to export a backup first.
            </p>
            <button class="btn btn-danger btn-block" onclick="clearAllData()">
              Clear All Data
            </button>
          </div>

          <!-- App Info -->
          <div class="card mt-lg" style="background: var(--color-background);">
            <h2 class="mb-md" style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: #E0E7FF; color: #3730A3; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">INFO</span>
              <span>About</span>
            </h2>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <div style="display: flex; justify-content: space-between;">
                <span class="text-muted">Total Contacts</span>
                <span style="font-weight: 600;">${AppState.contacts.length}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span class="text-muted">Total Interactions</span>
                <span style="font-weight: 600;">${AppState.interactions.length}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span class="text-muted">Version</span>
                <span style="font-weight: 600;">2.14</span>
              </div>
            </div>
          </div>
          </div>
        </div>
      `;
    }

    /* ===== SAMPLE DATA (for testing) ===== */

    function loadSampleData() {
      if (AppState.contacts.length > 0) {
        if (!confirm('This will add sample data to your existing contacts. Continue?')) {
          return;
        }
      }

      const sampleContacts = [
        { firstName: 'Mom', lastName: '', relationshipType: 'Family', phone: '(555) 123-4567', birthdayMonth: 'March', birthdayDay: '15', howWeMet: 'Family' },
        { firstName: 'Sarah', lastName: 'Johnson', relationshipType: 'Close Friend', email: 'sarah@email.com', linkedin: 'https://linkedin.com/in/sarahjohnson', industry: 'Technology', birthdayMonth: 'July', birthdayDay: '22', howWeMet: 'College' },
        { firstName: 'Alex', lastName: 'Chen', relationshipType: 'Friend', phone: '(555) 234-5678', email: 'alex@email.com', industry: 'Design', birthdayMonth: 'November', birthdayDay: '8', howWeMet: 'Work' },
        { firstName: 'Mike', lastName: 'Davis', relationshipType: 'Professional', email: 'mike@company.com', linkedin: 'https://linkedin.com/in/mikedavis', industry: 'Finance', howWeMet: 'Conference' },
        { firstName: 'Emma', lastName: 'Wilson', relationshipType: 'Acquaintance', email: 'emma@email.com', industry: 'Marketing', birthdayMonth: 'January', birthdayDay: '30', howWeMet: 'Mutual friend' }
      ];

      sampleContacts.forEach(data => {
        const contact = addContact(data);

        // Add some sample interactions
        const now = new Date();
        const interactions = [
          { days: 2, type: 'Call', notes: 'Caught up on life' },
          { days: 15, type: 'Text', notes: 'Quick check-in' },
          { days: 30, type: 'In-Person', notes: 'Coffee meeting' }
        ];

        interactions.slice(0, Math.floor(Math.random() * 3) + 1).forEach(int => {
          const date = new Date(now);
          date.setDate(date.getDate() - int.days);
          addInteraction({
            contactId: contact.id,
            date: date.toISOString().split('T')[0],
            type: int.type,
            notes: int.notes
          });
        });
      });

      showToast('Sample data loaded');
      renderCurrentView();
    }

    /* ===== LINKEDIN ENRICHMENT SYSTEM ===== */

    // Upload and parse LinkedIn CSV into reference database
    function handleLinkedInCSVUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.endsWith('.csv')) {
        showToast('Please select a CSV file', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const csv = e.target.result;
        parseLinkedInCSV(csv);
      };
      reader.readAsText(file);
    }

    function parseLinkedInCSV(csv) {
      const lines = csv.split('\n');
      if (lines.length < 2) {
        showToast('CSV file appears to be empty', 'error');
        return;
      }

      // Find the header row (look for the row with "First Name")
      let headerRowIndex = -1;
      for (let i = 0; i < Math.min(10, lines.length); i++) {
        if (lines[i].toLowerCase().includes('first name')) {
          headerRowIndex = i;
          break;
        }
      }

      if (headerRowIndex === -1) {
        showToast('Could not find header row in CSV. Please make sure this is a LinkedIn Connections CSV.', 'error');
        return;
      }

      // Parse header row
      const headers = lines[headerRowIndex].split(',').map(h => h.trim().replace(/"/g, ''));
      
      // Find column indices (LinkedIn CSV format)
      const urlIdx = headers.findIndex(h => h.toLowerCase().includes('url'));
      const firstNameIdx = headers.findIndex(h => h.toLowerCase().includes('first name'));
      const lastNameIdx = headers.findIndex(h => h.toLowerCase().includes('last name'));
      const emailIdx = headers.findIndex(h => h.toLowerCase().includes('email'));
      const companyIdx = headers.findIndex(h => h.toLowerCase().includes('company'));
      const positionIdx = headers.findIndex(h => h.toLowerCase().includes('position'));
      const connectedOnIdx = headers.findIndex(h => h.toLowerCase().includes('connected on'));
      const locationIdx = headers.findIndex(h => h.toLowerCase().includes('location'));

      // Parse data rows (start after header row)
      const linkedinRecords = [];
      for (let i = headerRowIndex + 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const values = parseCSVLine(line);
        if (values.length < 2) continue;

        const url = urlIdx >= 0 ? values[urlIdx]?.trim() : '';
        if (!url) continue; // Skip if no LinkedIn URL

        const record = {
          url: url,
          firstName: firstNameIdx >= 0 ? values[firstNameIdx]?.trim() : '',
          lastName: lastNameIdx >= 0 ? values[lastNameIdx]?.trim() : '',
          email: emailIdx >= 0 ? values[emailIdx]?.trim() : '',
          company: companyIdx >= 0 ? values[companyIdx]?.trim() : '',
          position: positionIdx >= 0 ? values[positionIdx]?.trim() : '',
          location: locationIdx >= 0 ? values[locationIdx]?.trim() : '',
          connectedOn: connectedOnIdx >= 0 ? values[connectedOnIdx]?.trim() : ''
        };

        linkedinRecords.push(record);
      }

      if (linkedinRecords.length === 0) {
        showToast('No valid LinkedIn data found in CSV', 'error');
        return;
      }

      // Save to AppState and localStorage
      AppState.linkedinData = linkedinRecords;
      saveState();
      
      showToast(`LinkedIn reference database loaded: ${linkedinRecords.length} profiles`, 'success');
      
      // Clear file input
      document.getElementById('linkedin-file-input').value = '';
      
      renderCurrentView();
    }

    // Extract LinkedIn username from various URL formats
    function extractLinkedInUsername(url) {
      if (!url) return null;
      
      // Handle various LinkedIn URL formats:
      // https://www.linkedin.com/in/username
      // https://linkedin.com/in/username/
      // www.linkedin.com/in/username
      const match = url.match(/linkedin\.com\/in\/([^\/\?]+)/i);
      return match ? match[1].toLowerCase() : null;
    }

    // Find LinkedIn data for a contact based on their LinkedIn URL
    function findLinkedInData(linkedinUrl) {
      if (!linkedinUrl || AppState.linkedinData.length === 0) return null;
      
      const username = extractLinkedInUsername(linkedinUrl);
      if (!username) return null;

      return AppState.linkedinData.find(record => {
        const recordUsername = extractLinkedInUsername(record.url);
        return recordUsername === username;
      });
    }

    // Enrich a single contact with LinkedIn data
    function enrichContact(contactId, options = {}) {
      const contact = AppState.contacts.find(c => c.id === contactId);
      if (!contact || !contact.linkedin) return null;

      const linkedinData = findLinkedInData(contact.linkedin);
      if (!linkedinData) return null;

      const conflicts = [];
      const updates = {};

      // Check each field for conflicts or updates
      const fieldsToCheck = [
        { key: 'company', label: 'Company' },
        { key: 'position', label: 'Position' }
      ];

      fieldsToCheck.forEach(field => {
        const currentValue = contact[field.key]?.trim();
        const newValue = linkedinData[field.key]?.trim();

        if (newValue && newValue !== currentValue) {
          if (currentValue && currentValue !== newValue) {
            // Conflict: both values exist and differ
            conflicts.push({
              field: field.key,
              label: field.label,
              current: currentValue,
              new: newValue
            });
          } else if (!currentValue) {
            // No conflict: field is empty, just fill it
            updates[field.key] = newValue;
          }
        }
      });

      // Handle Connected On date (always add to notes if not present)
      if (linkedinData.connectedOn && !contact.notes?.includes('Connected on LinkedIn:')) {
        const noteAddition = `Connected on LinkedIn: ${linkedinData.connectedOn}`;
        updates.notes = contact.notes ? `${contact.notes}\n${noteAddition}` : noteAddition;
      }

      // If auto-resolve is enabled, overwrite conflicts
      if (options.autoResolve) {
        conflicts.forEach(conflict => {
          updates[conflict.field] = conflict.new;
        });
        return { updates, conflicts: [] };
      }

      return { updates, conflicts };
    }

    // Enrich all contacts with LinkedIn URLs
    function enrichAllContacts(autoResolve = false) {
      const contactsWithLinkedIn = AppState.contacts.filter(c => c.linkedin);
      
      if (contactsWithLinkedIn.length === 0) {
        showToast('No contacts have LinkedIn URLs', 'warning');
        return;
      }

      if (AppState.linkedinData.length === 0) {
        showToast('Please upload LinkedIn CSV first', 'error');
        return;
      }

      let enriched = 0;
      let conflictsFound = [];

      contactsWithLinkedIn.forEach(contact => {
        const result = enrichContact(contact.id, { autoResolve });
        
        if (result) {
          // Apply non-conflicting updates
          if (Object.keys(result.updates).length > 0) {
            Object.assign(contact, result.updates);
            enriched++;
          }

          // Track conflicts for user review
          if (result.conflicts.length > 0) {
            conflictsFound.push({
              contactId: contact.id,
              contactName: `${contact.firstName} ${contact.lastName}`,
              conflicts: result.conflicts
            });
          }
        }
      });

      // Save conflicts and updated contacts
      AppState.enrichmentConflicts = conflictsFound;
      saveState();

      // Show results
      if (enriched > 0) {
        showToast(`Enriched ${enriched} contact(s) with LinkedIn data`, 'success');
      }
      
      if (conflictsFound.length > 0) {
        showToast(`${conflictsFound.length} contact(s) have conflicts - check Contacts page`, 'warning');
      }

      if (enriched === 0 && conflictsFound.length === 0) {
        showToast('No new data to enrich', 'info');
      }

      renderCurrentView();
    }

    // Auto-enrich when adding/editing contact with LinkedIn URL
    function autoEnrichContact(contactId) {
      const result = enrichContact(contactId, { autoResolve: false });
      
      if (result && Object.keys(result.updates).length > 0) {
        const contact = AppState.contacts.find(c => c.id === contactId);
        Object.assign(contact, result.updates);
        saveState();
        return true;
      }
      
      return false;
    }

    // Resolve a specific conflict
    function resolveConflict(contactId, field, useNew) {
      const contact = AppState.contacts.find(c => c.id === contactId);
      const conflictIndex = AppState.enrichmentConflicts.findIndex(c => c.contactId === contactId);
      
      if (!contact || conflictIndex === -1) return;

      const conflictData = AppState.enrichmentConflicts[conflictIndex];
      const conflict = conflictData.conflicts.find(c => c.field === field);
      
      if (!conflict) return;

      if (useNew) {
        contact[field] = conflict.new;
      }

      // Remove this conflict from the list
      conflictData.conflicts = conflictData.conflicts.filter(c => c.field !== field);
      
      // If no more conflicts for this contact, remove the entry
      if (conflictData.conflicts.length === 0) {
        AppState.enrichmentConflicts.splice(conflictIndex, 1);
      }

      saveState();
      renderCurrentView();
    }

    // Clear LinkedIn reference database
    function clearLinkedInData() {
      if (confirm('This will remove the LinkedIn reference database. You can re-upload the CSV anytime. Continue?')) {
        AppState.linkedinData = [];
        AppState.enrichmentConflicts = [];
        saveState();
        showToast('LinkedIn reference database cleared', 'success');
        renderCurrentView();
      }
    }

    /* ===== AUTOMATIC BACKUP ===== */

    function getDateInPST() {
      // Get current date in PST/PDT timezone
      const now = new Date();
      const pstOptions = { timeZone: 'America/Los_Angeles', year: 'numeric', month: '2-digit', day: '2-digit' };
      const pstDate = now.toLocaleDateString('en-CA', pstOptions); // en-CA gives YYYY-MM-DD format
      return pstDate;
    }

    function getHourInPST() {
      const now = new Date();
      const pstOptions = { timeZone: 'America/Los_Angeles', hour: 'numeric', hour12: false };
      return parseInt(now.toLocaleString('en-US', pstOptions));
    }

    function autoBackupData() {
      // Silent backup - doesn't show toast
      try {
        const data = {
          version: '1.0',
          exportedAt: new Date().toISOString(),
          contacts: AppState.contacts,
          interactions: AppState.interactions,
          totalContacts: AppState.contacts.length,
          totalInteractions: AppState.interactions.length,
          autoBackup: true
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `relationship-crm-auto-backup-${getDateInPST()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Store that we've done today's backup
        localStorage.setItem('relationship-crm-last-auto-backup', getDateInPST());
        console.log('Auto backup completed:', getDateInPST());
      } catch (error) {
        console.error('Auto backup error:', error);
      }
    }

    function checkAutoBackup() {
      // Only backup if there's data to backup
      if (AppState.contacts.length === 0) return;

      const todayPST = getDateInPST();
      const lastBackup = localStorage.getItem('relationship-crm-last-auto-backup');
      const currentHourPST = getHourInPST();

      // Backup if:
      // 1. It's midnight hour (0-1) in PST
      // 2. We haven't backed up today yet
      if (currentHourPST === 0 && lastBackup !== todayPST) {
        autoBackupData();
      }
    }

    function setupAutoBackup() {
      // Check for backup every 30 minutes
      setInterval(checkAutoBackup, 30 * 60 * 1000);
      // Also check immediately on load (in case app was opened right after midnight)
      setTimeout(checkAutoBackup, 5000); // Delay 5 seconds to let app fully initialize
    }

    /* ===== THEME TOGGLE ===== */

    function loadTheme() {
      const savedTheme = localStorage.getItem('relationship-crm-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = savedTheme === 'dark' || (savedTheme === null && prefersDark);

      if (isDark) {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
      
      // Update menu theme text if it exists (after DOM is loaded)
      updateUserMenuThemeText();
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('relationship-crm-theme', isDark ? 'dark' : 'light');
      // Update user menu theme text
      updateUserMenuThemeText();
    }

    /* ===== HAMBURGER MENU ===== */

    function toggleMenu() {
      const menu = document.getElementById('slide-menu');
      const overlay = document.querySelector('.menu-overlay');
      menu.classList.toggle('active');
      overlay.classList.toggle('active');
      document.body.style.overflow = menu.classList.contains('active') ? 'hidden' : '';
    }

    function closeMenu() {
      const menu = document.getElementById('slide-menu');
      const overlay = document.querySelector('.menu-overlay');
      menu.classList.remove('active');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    function navigateFromMenu(route) {
      closeMenu();
      navigateTo(route);
    }

    function updateMenuActiveState() {
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
        const route = item.getAttribute('data-route');
        if (route === AppState.currentView ||
            (route === 'contacts' && ['contact', 'edit-contact', 'add-contact', 'enrichment-conflicts'].includes(AppState.currentView)) ||
            (route === 'dashboard' && AppState.currentView === 'dashboard')) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }

    /* ===== USER MENU ===== */

    function toggleUserMenu() {
      const container = document.getElementById('user-menu');
      if (container) {
        container.classList.toggle('open');
      }
    }

    function closeUserMenu() {
      const container = document.getElementById('user-menu');
      if (container) {
        container.classList.remove('open');
      }
    }

    function handleUserMenuAction(action) {
      closeUserMenu();

      switch (action) {
        case 'add-contact':
          navigateTo('add-contact');
          break;
        case 'toggle-theme':
          toggleTheme();
          break;
        case 'sign-out':
          handleSignOut();
          break;
      }
    }

    function updateUserMenuThemeText() {
      const isDark = document.body.classList.contains('dark-mode');
      const themeIcon = document.getElementById('menu-theme-icon');
      const themeText = document.getElementById('menu-theme-text');
      if (themeIcon) themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      if (themeText) themeText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    }

    function updateUserMenuDisplay() {
      const authButton = document.getElementById('auth-button');
      const userMenu = document.getElementById('user-menu');
      const headerTitle = document.getElementById('header-title');

      if (currentUser) {
        // Hide sign in button, show user menu
        if (authButton) authButton.style.display = 'none';
        if (userMenu) {
          userMenu.style.display = 'block';

          // Populate user info
          const avatar = document.getElementById('user-avatar');
          const avatarLarge = document.getElementById('user-avatar-large');
          const nameDisplay = document.getElementById('user-name-display');
          const menuName = document.getElementById('user-menu-name');
          const menuEmail = document.getElementById('user-menu-email');

          const photoURL = currentUser.photoURL || '';
          const displayName = currentUser.displayName || 'User';
          const email = currentUser.email || '';
          const firstName = displayName.split(' ')[0];
          
          // Get initials for fallback
          const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

          // Set avatar with fallback
          if (avatar) {
            if (photoURL) {
              avatar.src = photoURL;
              avatar.style.display = 'block';
              // Add error handler to show initials if image fails to load
              avatar.onerror = () => {
                avatar.style.display = 'none';
                const initialsSpan = document.createElement('span');
                initialsSpan.textContent = initials;
                initialsSpan.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; background: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem;';
                avatar.parentNode.insertBefore(initialsSpan, avatar);
              };
            } else {
              // No photo URL, show initials
              avatar.style.display = 'none';
              const initialsSpan = document.createElement('span');
              initialsSpan.textContent = initials;
              initialsSpan.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; background: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem;';
              avatar.parentNode.insertBefore(initialsSpan, avatar);
            }
          }
          
          if (avatarLarge) {
            if (photoURL) {
              avatarLarge.src = photoURL;
              avatarLarge.onerror = () => {
                avatarLarge.style.display = 'none';
                const initialsSpan = document.createElement('span');
                initialsSpan.textContent = initials;
                initialsSpan.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; background: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem;';
                avatarLarge.parentNode.insertBefore(initialsSpan, avatarLarge);
              };
            } else {
              avatarLarge.style.display = 'none';
            }
          }
          
          if (nameDisplay) nameDisplay.textContent = firstName;
          if (menuName) menuName.textContent = displayName;
          if (menuEmail) menuEmail.textContent = email;
        }

        // Make header title clickable when signed in
        if (headerTitle) {
          headerTitle.style.cursor = 'pointer';
          headerTitle.onclick = () => navigateTo('dashboard');
        }

        // Update theme text in menu
        updateUserMenuThemeText();
      } else {
        // Hide user menu and sign in button (login screen has its own button)
        if (userMenu) userMenu.style.display = 'none';
        if (authButton) authButton.style.display = 'none';
        
        // Make header title non-clickable when signed out
        if (headerTitle) {
          headerTitle.style.cursor = 'default';
          headerTitle.onclick = null;
        }
      }
    }

    /* ===== INITIALIZATION ===== */

    /* ===== INITIALIZATION ===== */

    function init() {
      console.log('üöÄ Initializing app...');
      
      // Load theme preference (still uses localStorage - device-specific)
      loadTheme();

      // Verify DOM is ready
      const appElement = document.getElementById('app');
      if (!appElement) {
        console.error('‚ùå App element not found! DOM may not be ready.');
        return;
      }
      
      console.log('‚úÖ App element found, rendering login screen...');

      // Show login screen immediately while waiting for Firebase to initialize
      // This prevents a blank screen on first load
      try {
        renderLoginScreen();
        console.log('‚úÖ Login screen rendered');
      } catch (error) {
        console.error('‚ùå Error rendering login screen:', error);
      }

      // Set up Firebase authentication listener
      onAuthStateChanged(auth, async (user) => {
        try {
          currentUser = user;
          console.log('üî• Auth state changed. User:', user ? user.displayName : 'null');
          
          if (user) {
            console.log('User signed in:', user.displayName);
            
            // Load data from Firestore
            console.log('üì• Loading data from Firestore...');
            await loadState();
            console.log('‚úÖ Data loaded successfully');
            
            // Set up real-time sync
            console.log('üîÑ Setting up real-time sync...');
            setupRealtimeSync();
            console.log('‚úÖ Real-time sync active');
            
            // Recalculate lastContactedAt for all contacts
            console.log('üìä Recalculating contact dates...');
            recalculateAllLastContactedDates();
            console.log('‚úÖ Contact dates recalculated');
            
            // Force render to dashboard with proper UI update
            console.log('üé® Rendering dashboard...');
            AppState.currentView = 'dashboard';
            updateUserMenuDisplay(); // Update header UI first
            renderCurrentView(); // Then render the view
            updateNavigation();
            console.log('‚úÖ Dashboard rendered successfully');
          } else {
            console.log('User signed out - rendering login screen');
            // Clear state and render login screen
            AppState.currentView = 'dashboard';
            updateUserMenuDisplay(); // Update header UI first
            renderCurrentView(); // Then render login screen
            console.log('‚úÖ Login screen rendered');
          }
        } catch (error) {
          console.error('‚ùå CRITICAL ERROR in auth state handler:', error);
          console.error('Error stack:', error.stack);
          // Try to render login screen as fallback
          try {
            renderLoginScreen();
          } catch (fallbackError) {
            console.error('‚ùå Even fallback failed:', fallbackError);
          }
        }
      });

      // Set up hash change listener
      window.addEventListener('hashchange', handleHashChange);

      // Close user menu when clicking outside
      document.addEventListener('click', (e) => {
        const userMenu = document.getElementById('user-menu');
        if (userMenu && userMenu.classList.contains('open')) {
          if (!userMenu.contains(e.target)) {
            closeUserMenu();
          }
        }
      });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        // ESC to close modal or menu
        if (e.key === 'Escape') {
          // Close user menu first
          const userMenu = document.getElementById('user-menu');
          if (userMenu && userMenu.classList.contains('open')) {
            closeUserMenu();
            return;
          }
          const menu = document.getElementById('slide-menu');
          if (menu && menu.classList.contains('active')) {
            closeMenu();
            return;
          }
          const modal = document.getElementById('interaction-modal');
          if (modal && modal.classList.contains('active')) {
            closeInteractionModal();
          }
        }

        // Ctrl/Cmd + K to search (focus search input if on contacts page)
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          if (AppState.currentView === 'contacts') {
            const searchInput = document.querySelector('input[type="search"]');
            if (searchInput) searchInput.focus();
          } else {
            navigateTo('contacts');
          }
        }

        // Ctrl/Cmd + N to add new contact
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          navigateTo('add-contact');
        }

        // Ctrl/Cmd + H to go home (dashboard)
        if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
          e.preventDefault();
          navigateTo('dashboard');
        }
      });

      // Activity tooltip positioning
      document.addEventListener('mouseenter', (e) => {
        const activityItem = e.target.closest('.activity-item');
        if (activityItem && activityItem.querySelector('.activity-tooltip')) {
          const rect = activityItem.getBoundingClientRect();
          const viewportHeight = window.innerHeight;
          const tooltip = activityItem.querySelector('.activity-tooltip');
          
          // Estimate tooltip height (300px is generous estimate)
          const estimatedTooltipHeight = 300;
          const spaceBelow = viewportHeight - rect.bottom;
          const spaceAbove = rect.top;
          
          // Show above if there's not enough space below OR if we're in the bottom 40% of viewport
          if (spaceBelow < estimatedTooltipHeight || rect.top > viewportHeight * 0.6) {
            activityItem.classList.add('tooltip-above');
          } else {
            activityItem.classList.remove('tooltip-above');
          }
        }
      }, true);

      // Set up automatic daily backup
      setupAutoBackup();

      console.log('Relationship CRM initialized with Firebase');
      console.log('Keyboard shortcuts:');
      console.log('  - ESC: Close modal');
      console.log('  - Ctrl/Cmd + K: Search contacts');
      console.log('  - Ctrl/Cmd + N: New contact');
      console.log('  - Ctrl/Cmd + H: Dashboard');
    }

    /* ===== EXPOSE FUNCTIONS TO WINDOW (CRITICAL FOR onclick HANDLERS) ===== */
    // These MUST execute before HTML tries to use them
    console.log('‚ö° Step 1: About to expose functions...');
    console.log('‚ö° Step 2: Testing if navigateTo exists in module scope:', typeof navigateTo);
    console.log('‚ö° Step 3: Testing if window exists:', typeof window);
    
    try {
      // Export ONLY functions that actually exist and are called from HTML
      const functionsToExport = {
        navigateTo,
        toggleTheme,
        toggleMenu,
        closeMenu,
        navigateFromMenu,
        toggleUserMenu,
        closeUserMenu,
        handleUserMenuAction,
        deleteContact,
        updateContact,
        openInteractionModal,
        closeInteractionModal,
        deleteInteraction,
        exportData,
        importData,
        importCSV,
        clearAllData,
        handleGoogleSignIn,
        handleSignOut,
        loadSampleData,
        handleLinkedInCSVUpload,
        enrichContact,
        resolveConflict,
        clearLinkedInData,
        deleteContactWithConfirm,
        handleContactFormCancel,
        handleContactFormSubmit,
        handleFrequencySelectChange,
        handleInteractionSubmit,
        toggleContactMuted,
        toggleContactPriority,
        toggleFilterType,
        selectInteractionType,
        selectQuickDate,
        removeTaggedContact,
        addTaggedContact,
        updateQuickDateButtons,
        renderContactList,
        openEditInteractionModal,
        deleteInteractionWithConfirm,
        duplicateInteraction,
        enrichAllContacts,
        downloadCSVTemplate,
        exportCSV,
        formatPhoneNumber
      };
      
      // Assign to both window and globalThis
      Object.keys(functionsToExport).forEach(name => {
        window[name] = functionsToExport[name];
        globalThis[name] = functionsToExport[name];
      });
      
      console.log('‚úÖ Step 4: Assignment complete!');
      console.log('‚úÖ Step 5: window.navigateTo type:', typeof window.navigateTo);
      console.log('‚úÖ Step 6: Exported', Object.keys(functionsToExport).length, 'functions');
    } catch (error) {
      console.error('‚ùå Error exposing functions:', error);
    }



    /* ===== EXPOSE FUNCTIONS TO WINDOW (FOR HTML onclick HANDLERS) ===== */
    // Export functions to window BEFORE starting the app
    
    // Duplicate exports removed - handled above in try-catch block
    
    console.log('‚úÖ All functions exposed to window');

    // Start the app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
